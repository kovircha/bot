import json
import os
import asyncio
import logging
import random
import time
import math
import aiosqlite
import sys
from colorama import init, Fore, Style
import aioconsole

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤
init(autoreset=True)
from aiogram import Bot, Dispatcher, F, types, BaseMiddleware
from aiogram.filters import Command, StateFilter
from aiogram.types import (
    ReplyKeyboardMarkup, KeyboardButton, 
    InlineKeyboardMarkup, InlineKeyboardButton,
    CallbackQuery, Message, BotCommand, FSInputFile,
    InputMediaPhoto

)
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
TOKEN = '8482572401:AAHR91Uwrq6U2-ody9jYUmQxme3xOeyzyvg'

# --- –ù–ê–°–¢–†–û–ô–ö–ò –ö–ê–ù–ê–õ–ê ---
# ID –∫–∞–Ω–∞–ª–∞ (–º–æ–∂–Ω–æ @username –∏–ª–∏ —á–∏—Å–ª–æ–≤–æ–π ID —Ç–∏–ø–∞ -100...)
# –í–ê–ñ–ù–û: –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º –≤ —ç—Ç–æ–º –∫–∞–Ω–∞–ª–µ!
REQUIRED_CHANNEL_ID = "@molokofarmoff" 
REQUIRED_CHANNEL_URL = "https://t.me/molokofarmoff"

# --- –ó–ê–ì–†–£–ó–ö–ê –ö–ê–†–¢ ---
def load_cards():
    with open("cards.json", "r", encoding="utf-8") as f:
        return json.load(f)

CARDS = load_cards()

# --- –ù–ê–°–¢–†–û–ô–ö–ò –†–ï–î–ö–û–°–¢–ò ---
RARITY_INFO = {
    "common": {
        "name": "–û–±—ã—á–Ω–∞—è", 
        "icon": "‚ö™Ô∏è",  # –°–µ—Ä—ã–π/–ë–µ–ª—ã–π
        "color_code": 0x808080 # –ö–æ–¥ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)
    },
    "rare": {
        "name": "–†–µ–¥–∫–∞—è", 
        "icon": "üü¢",  # –ó–µ–ª–µ–Ω—ã–π
        "color_code": 0x00FF00
    },
    "epic": {
        "name": "–≠–ø–∏—á–µ—Å–∫–∞—è", 
        "icon": "üü£",  # –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        "color_code": 0x800080
    },
    "limited": {
        "name": "–õ–ò–ú–ò–¢–ö–ê", 
        "icon": "üè≥Ô∏è‚Äçüåà", # RGB / –†–∞–¥—É–≥–∞
        "color_code": 0xFFD700
    }
}

class AdminPanelStates(StatesGroup):
    waiting_for_user_id = State() # –ñ–¥–µ–º ID –∏–≥—Ä–æ–∫–∞
    waiting_for_value = State()   # –ñ–¥–µ–º —á–∏—Å–ª–æ –∏–ª–∏ —Ç–µ–∫—Å—Ç

class MarketStates(StatesGroup):
    waiting_for_price = State()
    card_id_to_sell = State() # –¢—É—Ç –±—É–¥–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫—É—é –∫–∞—Ä—Ç—É –ø—Ä–æ–¥–∞–µ–º

# --- FSM ---
class GameStates(StatesGroup):
    waiting_for_code = State()
    waiting_for_broadcast = State()

# --- MIDDLEWARE ---
# --- MIDDLEWARE (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) ---
class GameMiddleware(BaseMiddleware):
    async def __call__(self, handler, event: Message, data: dict):
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç User (–¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –∫–æ–ª–±—ç–∫–æ–≤)
        if isinstance(event, Message):
            user = event.from_user
        elif isinstance(event, CallbackQuery):
            user = event.from_user
        else:
            return await handler(event, data)
            
        if not user: return await handler(event, data)

        # 1. –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –∏ –í–†–ï–ú–Ø –ê–ö–¢–ò–í–ù–û–°–¢–ò
        current_time = time.time()
        asyncio.create_task(update_username(user.id, user.full_name))
        
        # –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (fire and forget)
        async def set_active():
            async with aiosqlite.connect(DB_NAME) as db:
                await db.execute('UPDATE users SET last_active = ? WHERE user_id = ?', (current_time, user.id))
                await db.commit()
        asyncio.create_task(set_active())

        # 1. –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ –ë–î
        asyncio.create_task(update_username(user.id, user.full_name))

        # 2. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ê–¥–º–∏–Ω–æ–≤ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫
        if user.username and user.username.lower() in ADMINS:
            return await handler(event, data)

        # --- –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò –ü–û–î–ü–ò–°–ö–ò ---
        try:
            # –°–ø—Ä–∞—à–∏–≤–∞–µ–º —É –¢–µ–ª–µ–≥—Ä–∞–º–∞ —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–∞–Ω–∞–ª–µ
            chat_member = await bot.get_chat_member(chat_id=REQUIRED_CHANNEL_ID, user_id=user.id)
            
            # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 'left' (—É—à–µ–ª) –∏–ª–∏ 'kicked' (–≤—ã–≥–Ω–∞–Ω) -> –ë–ª–æ–∫–∏—Ä—É–µ–º
            if chat_member.status in ['left', 'kicked']:
                
                # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                kb = InlineKeyboardMarkup(inline_keyboard=[
                    [InlineKeyboardButton(text="üì¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª", url=REQUIRED_CHANNEL_URL)],
                    [InlineKeyboardButton(text="‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è", callback_data="check_subscription")]
                ])

                # –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç
                if isinstance(event, CallbackQuery) and event.data == "check_subscription":
                    await event.answer("‚ùå –í—ã –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.", show_alert=True)
                    return 

                # –ï—Å–ª–∏ –ø–∏—à—É—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∂–º—É—Ç –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏
                if isinstance(event, Message):
                    await event.answer(
                        "üîí <b>–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç!</b>\n\n–î–ª—è –∏–≥—Ä—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–º –Ω–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞.",
                        reply_markup=kb,
                        parse_mode="HTML"
                    )
                elif isinstance(event, CallbackQuery):
                    # –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –∫–ª–∏–∫ –ø–æ –¥—Ä—É–≥–æ–π –∫–Ω–æ–ø–∫–µ
                    await event.message.answer("üîí –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª!", reply_markup=kb)
                    await event.answer()
                
                # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É (–Ω–µ –ø—É—Å–∫–∞–µ–º –¥–∞–ª—å—à–µ)
                return 
                
        except Exception as e:
            # –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∞–¥–º–∏–Ω –∏–ª–∏ –∫–∞–Ω–∞–ª —É–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ - –ø–∏—à–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å, –Ω–æ –∏–≥—Ä–æ–∫–∞ –ø—É—Å–∫–∞–µ–º
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ (–ë–æ—Ç –Ω–µ –∞–¥–º–∏–Ω?): {e}")

        # --- –õ–û–ì–ò–ö–ê –ê–ù–¢–ò-–°–ü–ê–ú–ê (–û—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –±—ã–ª–∞) ---
        current_time = time.time()
        if user.id in muted_users:
            if current_time < muted_users[user.id]: return 
            else: del muted_users[user.id]

        if user.id not in user_timestamps: user_timestamps[user.id] = []
        user_timestamps[user.id] = [t for t in user_timestamps[user.id] if current_time - t < 1.0]
        user_timestamps[user.id].append(current_time)
        
        if len(user_timestamps[user.id]) > SPAM_LIMIT:
            muted_users[user.id] = current_time + MUTE_TIME
            if isinstance(event, Message):
                await event.answer(f"‚õîÔ∏è <b>–û—Å—Ç—ã–Ω—å!</b> –ú—É—Ç –Ω–∞ {MUTE_TIME} —Å–µ–∫.", parse_mode="HTML")
            elif isinstance(event, CallbackQuery):
                await event.answer(f"‚õîÔ∏è –û—Å—Ç—ã–Ω—å! –ú—É—Ç –Ω–∞ {MUTE_TIME} —Å–µ–∫.", show_alert=True)
            return 
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –º–µ–Ω—é (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π)
        valid_buttons = [
            "‚ùÑÔ∏è –¢—Ä—è—Å—Ç–∏ –µ–ª–∫—É (–î–æ–∏—Ç—å)", "‚õÑÔ∏è –õ–µ–ø–∏—Ç—å —Å–Ω–µ–≥–æ–≤–∏–∫–∞ (–ü–æ–ª–∏—Ç—å)", "üè∞ –ì–æ—Ä–æ–¥", "üé° –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è", "üë§ –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å",
            "üéÖ –õ–∞–≤–∫–∞ –°–∞–Ω—Ç—ã", "üéí –°–∫–ª–∞–¥", "üèÜ –õ–∏–¥–µ—Ä—ã", "üìü –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥", "üîô –ù–∞–∑–∞–¥",
            "üé≤ –ö—Ä—É—Ç–∏—Ç—å —Å–ª–æ—Ç", "üéÅ –ü–æ–¥–∞—Ä–æ–∫ (–ï–∂–µ–¥–Ω.)", "üë∫ –ì—Ä–∏–Ω—á (–ò–≤–µ–Ω—Ç)", "üé¥ –ö–∞—Ä—Ç–æ—á–∫–∏"
        ]
        
        if isinstance(event, Message) and not event.text.startswith("/") and event.text not in valid_buttons:
             await event.answer("‚ö†Ô∏è –ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ.", reply_markup=main_keyboard())

        return await handler(event, data)

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–û–¢–ê ---
bot = Bot(token=TOKEN)
dp = Dispatcher(storage=MemoryStorage())

dp.message.middleware(GameMiddleware())

# –ü—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º —Å—É–Ω–¥—É–∫–æ–≤ (–ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª—ã close_chest.jpg –∏ open_chest.jpg –≤ –ø–∞–ø–∫—É —Å –±–æ—Ç–æ–º)
# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç
CHEST_CLOSE_PATH = "closed_chest.png" 
CHEST_OPEN_PATH = "open_chest.png"

# –°—Å—ã–ª–∫–∏-–∑–∞–≥–ª—É—à–∫–∏ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤)
URL_CHEST_CLOSE = ""
URL_CHEST_OPEN = "https://img.freepik.com/premium-vector/opened-wooden-chest-box-with-gold-coins-game-ui-asset-vector-illustration_1045168-19.jpg"

DAILY_COOLDOWN = 86400 # 24 —á–∞—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
JACKPOT_CHANCE = 100000 # 1 –∫ 100 000

# --- –ê–ù–ò–ú–ê–¶–ò–Ø –ì–†–ò–ù–ß–ê ---
# –ü—É—Ç–∏ –∫ –ª–æ–∫–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–∞–º
GRINCH_FRAMES = ["grinch_1.jpg", "grinch_2.jpg", "grinch_3.jpg", "grinch_4.jpg"]

# –°—Å—ã–ª–∫–∏ (–∑–∞–≥–ª—É—à–∫–∏, –µ—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç)
GRINCH_URLS = [
    "https://img.freepik.com/premium-photo/snowball-flight-winter-background_1045168-101.jpg", # –ö–∞–¥—Ä 1: –ü–æ–ª–µ—Ç
    "https://img.freepik.com/premium-photo/grinch-hit-by-snowball-funny_1045168-102.jpg",      # –ö–∞–¥—Ä 2: –£–¥–∞—Ä
    "https://img.freepik.com/premium-photo/grinch-running-away-with-bag_1045168-103.jpg",       # –ö–∞–¥—Ä 3: –ü–æ–±–µ–≥
    "https://img.freepik.com/premium-photo/grinch-running-away-with-bag_1045168-103.jpg"
]

# –ê–¥–º–∏–Ω—ã (–±–µ–∑ @)
ADMINS = ['silentglove', 'octoberchaos']

# –õ–æ–≥–æ—Ç–∏–ø (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª logo.jpg - —é–∑–∞–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ —Å—Å—ã–ª–∫—É)
LOGO_PATH = "logo new year.png"
DEFAULT_LOGO_URL = "https://storage.googleapis.com/pod_public/1300/243765.jpg"

# --- –ò–í–ï–ù–¢ –ü–£–ì–ê–õ–û ---
# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º (–∑–∞–∫–∏–Ω—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ scarecrow_bad.jpg –∏ scarecrow_good.jpg –≤ –ø–∞–ø–∫—É)
SCARECROW_BAD_PATH = "scarecrow_bad.jpg"   # –ü—É–≥–∞–ª–æ –≤ –≤–æ—Ä–æ–Ω–∞—Ö
SCARECROW_GOOD_PATH = "scarecrow_good.jpg" # –î–æ–≤–æ–ª—å–Ω–æ–µ –ø—É–≥–∞–ª–æ

# –°—Å—ã–ª–∫–∏ –∑–∞–≥–ª—É—à–∫–∏
URL_SCARECROW_BAD = "https://img.freepik.com/premium-photo/scarecrow-standing-cornfield-with-crows-flying-around-generated-by-ai_1038957-257.jpg"
URL_SCARECROW_GOOD = "https://img.freepik.com/premium-photo/cute-scarecrow-cartoon-character-generated-ai_406939-9305.jpg"

SCARECROW_COOLDOWN = 10800  # 3 —á–∞—Å–∞ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
BOOST_DURATION = 1800       # 30 –º–∏–Ω—É—Ç –¥–µ–π—Å—Ç–≤–∏—è –±—É—Å—Ç–∞ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)

# --- –ë–ê–õ–ê–ù–° –ò –¶–ï–ù–´ ---
MILK_PER_CLICK = 1
BASE_PLANT_COST = 5
BASE_CASINO_COST = 10
FERT_EFFECT = 5

# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
DB_NAME = 'farm_v4.db'

# --- ANTI-SPAM ---
SPAM_LIMIT = 12 # –ß—É—Ç—å –ø–æ–¥–Ω—è–ª –ª–∏–º–∏—Ç, —á—Ç–æ–±—ã –≤–µ—Å–µ–ª–µ–µ –∫–ª–∏–∫–∞—Ç—å
MUTE_TIME = 60
user_timestamps = {}
muted_users = {}



# 1. –ù–∞–∂–∞–ª–∏ "–ü—Ä–æ–¥–∞—Ç—å" –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
@dp.callback_query(F.data.startswith("sell_init_"))
async def sell_init(cb: CallbackQuery, state: FSMContext):
    card_id = cb.data.split("_")[2]
    
    await state.update_data(card_id=card_id)
    await state.set_state(MarketStates.waiting_for_price)
    
    card_name = CARDS[card_id]["name"]
    await cb.message.answer(f"üí∞ –ó–∞ —Å–∫–æ–ª—å–∫–æ –ø–æ–º–∏–¥–æ—Ä–æ–≤ —Ç—ã —Ö–æ—á–µ—à—å –ø—Ä–æ–¥–∞—Ç—å <b>{card_name}</b>?\n\n‚úçÔ∏è <i>–ù–∞–ø–∏—à–∏ —Ü–µ–Ω—É —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1000)</i>", parse_mode="HTML")
    await cb.answer()

# 2. –ò–≥—Ä–æ–∫ –≤–≤–µ–ª —Ü–µ–Ω—É
@dp.message(StateFilter(MarketStates.waiting_for_price))
async def sell_confirm(message: types.Message, state: FSMContext):
    try:
        price = int(message.text)
        if price < 1: raise ValueError
    except:
        await message.answer("‚ùå –í–≤–µ–¥–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0.")
        return

    data = await state.get_data()
    card_id = data['card_id']
    user_id = message.from_user.id
    username = message.from_user.full_name

    async with aiosqlite.connect(DB_NAME) as db:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—é–ø–∞)
        async with db.execute('SELECT count FROM user_cards WHERE user_id = ? AND card_id = ?', (user_id, card_id)) as c:
            row = await c.fetchone()
            
        if not row or row[0] < 1:
            await message.answer("‚ùå –£ —Ç–µ–±—è —É–∂–µ –Ω–µ—Ç —ç—Ç–æ–π –∫–∞—Ä—Ç—ã!")
            await state.clear()
            return

        # 1. –ó–∞–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—É —É –∏–≥—Ä–æ–∫–∞
        new_count = row[0] - 1
        if new_count == 0:
            await db.execute('DELETE FROM user_cards WHERE user_id = ? AND card_id = ?', (user_id, card_id))
        else:
            await db.execute('UPDATE user_cards SET count = ? WHERE user_id = ? AND card_id = ?', (new_count, user_id, card_id))
            
        # 2. –í—ã—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ —Ä—ã–Ω–æ–∫
        await db.execute('INSERT INTO market (seller_id, seller_name, card_id, price) VALUES (?, ?, ?, ?)', 
                         (user_id, username, card_id, price))
        await db.commit()

    await message.answer(f"‚úÖ –õ–æ—Ç —Å–æ–∑–¥–∞–Ω! <b>{CARDS[card_id]['name']}</b> –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –∑–∞ {price} üçÖ.", parse_mode="HTML")
    await state.clear()

# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
CARDS_DIR = "img_cards"

async def send_card_info(message: types.Message, card_id: str, count: int = 1):
    if card_id not in CARDS:
        await message.answer("–û—à–∏–±–∫–∞: –∫–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    card = CARDS[card_id]
    rarity_data = RARITY_INFO.get(card["rarity"], RARITY_INFO["common"])
    
    # –¢–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏
    caption = (
        f"{rarity_data['icon']} <b>{card['name']}</b>\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"üé≠ –†–µ–¥–∫–æ—Å—Ç—å: {rarity_data['name']}\n"
        f"üìú –û–ø–∏—Å–∞–Ω–∏–µ: <i>{card.get('desc', '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</i>\n"
        f"üéí –£ —Ç–µ–±—è –≤ –Ω–∞–ª–∏—á–∏–∏: <b>{count} —à—Ç.</b>"
    )

    # –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–¥–∞–∂–∏
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=f"üí∞ –ü—Ä–æ–¥–∞—Ç—å –∫–∞—Ä—Ç—É", callback_data=f"sell_init_{card_id}")]
    ])

    # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É
    image_filename = card.get("img", "default.jpg") # –ï—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–∞, –∏—â–µ–º default.jpg
    image_path = os.path.join(CARDS_DIR, image_filename)
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
        if os.path.exists(image_path):
            photo = FSInputFile(image_path)
            await message.answer_photo(photo, caption=caption, reply_markup=kb, parse_mode="HTML")
        else:
            # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç - –∫–∏–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
            await message.answer(f"üñº <i>(–ö–∞—Ä—Ç–∏–Ω–∫–∞ {image_filename} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞)</i>\n\n" + caption, reply_markup=kb, parse_mode="HTML")
    except Exception as e:
        await message.answer(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: {e}\n\n" + caption, reply_markup=kb, parse_mode="HTML")

# --- –ü–†–û–î–í–ò–ù–£–¢–´–ô –†–´–ù–û–ö ---

async def get_market_page(page: int = 0):
    LIMIT = 1  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ 1 –ª–æ—Ç—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–∫–∞–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –¢–∏–Ω–¥–µ—Ä–µ/–ê–≤–∏—Ç–æ)
    offset = page * LIMIT
    
    async with aiosqlite.connect(DB_NAME) as db:
        # –°—á–∏—Ç–∞–µ–º –≤—Å–µ–≥–æ –ª–æ—Ç–æ–≤
        async with db.execute('SELECT COUNT(*) FROM market') as c:
            total_lots = (await c.fetchone())[0]
            
        # –ë–µ—Ä–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ª–æ—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async with db.execute('SELECT lot_id, seller_name, card_id, price, seller_id FROM market ORDER BY lot_id DESC LIMIT ? OFFSET ?', (LIMIT, offset)) as c:
            lot = await c.fetchone()
            
    return lot, total_lots

@dp.message(F.text == "üè™ –†—ã–Ω–æ–∫ –∏–≥—Ä–æ–∫–æ–≤")
async def show_market(message: types.Message):
    await show_market_page(message, page=0)

async def show_market_page(message_or_call, page=0):
    lot, total = await get_market_page(page)
    
    if not lot:
        text = "üè™ <b>–†—ã–Ω–æ–∫ –ø—É—Å—Ç!</b>\n–°—Ç–∞–Ω—å –ø–µ—Ä–≤—ã–º –ø—Ä–æ–¥–∞–≤—Ü–æ–º, –≤—ã—Å—Ç–∞–≤–∏–≤ –∫–∞—Ä—Ç—É –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è."
        if isinstance(message_or_call, CallbackQuery):
            await message_or_call.message.edit_text(text, parse_mode="HTML")
        else:
            await message_or_call.answer(text, parse_mode="HTML")
        return

    # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ª–æ—Ç–∞
    lot_id, seller, card_id, price, seller_id = lot
    card_info = CARDS.get(card_id, {"name": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞", "rarity": "common"})
    rarity_icon = RARITY_INFO.get(card_info.get("rarity", "common"), {}).get("icon", "‚ö™Ô∏è")
    
    text = (
        f"üè™ <b>–†–´–ù–û–ö (–õ–æ—Ç {page + 1}/{total})</b>\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"{rarity_icon} <b>{card_info['name']}</b>\n\n"
        f"üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: {seller}\n"
        f"üí∞ –¶–µ–Ω–∞: <b>{format_num(price)}</b> üçÖ\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
    )

    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –ø–æ–∫—É–ø–∫–∏
    buttons = []
    
    # –ö–Ω–æ–ø–∫–∞ –ø–æ–∫—É–ø–∫–∏ –∏–ª–∏ "–ú–æ–π –ª–æ—Ç"
    user_id = message_or_call.from_user.id
    if user_id == seller_id:
        buy_btn = InlineKeyboardButton(text="üóë –°–Ω—è—Ç—å —Å –ø—Ä–æ–¥–∞–∂–∏", callback_data=f"market_delete_{lot_id}")
    else:
        buy_btn = InlineKeyboardButton(text=f"üõí –ö—É–ø–∏—Ç—å –∑–∞ {price}", callback_data=f"buy_lot_{lot_id}")
    
    buttons.append([buy_btn])
    
    # –°—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    nav_row = []
    if page > 0:
        nav_row.append(InlineKeyboardButton(text="‚¨ÖÔ∏è", callback_data=f"market_page_{page-1}"))
    
    nav_row.append(InlineKeyboardButton(text=f"üìÑ {page+1}", callback_data="ignore"))
    
    if (page + 1) < total:
        nav_row.append(InlineKeyboardButton(text="‚û°Ô∏è", callback_data=f"market_page_{page+1}"))
        
    buttons.append(nav_row)
    buttons.append([InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"market_page_{page}")])

    kb = InlineKeyboardMarkup(inline_keyboard=buttons)
    
    if isinstance(message_or_call, CallbackQuery):
        await message_or_call.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    else:
        await message_or_call.answer(text, reply_markup=kb, parse_mode="HTML")

# –•–µ–Ω–¥–ª–µ—Ä –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è
@dp.callback_query(F.data.startswith("market_page_"))
async def market_nav(cb: CallbackQuery):
    page = int(cb.data.split("_")[2])
    await show_market_page(cb, page)
    await cb.answer()

# –•–µ–Ω–¥–ª–µ—Ä —É–¥–∞–ª–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –ª–æ—Ç–∞
@dp.callback_query(F.data.startswith("market_delete_"))
async def market_delete_own(cb: CallbackQuery):
    lot_id = int(cb.data.split("_")[2])
    user_id = cb.from_user.id
    
    async with aiosqlite.connect(DB_NAME) as db:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ª–æ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —é–∑–µ—Ä—É
        async with db.execute('SELECT card_id FROM market WHERE lot_id = ? AND seller_id = ?', (lot_id, user_id)) as c:
            row = await c.fetchone()
            
        if not row:
            await cb.answer("‚ùå –õ–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –ø—Ä–æ–¥–∞–Ω.", show_alert=True)
            await show_market_page(cb, 0)
            return
            
        card_id = row[0]
        
        # –£–¥–∞–ª—è–µ–º –ª–æ—Ç
        await db.execute('DELETE FROM market WHERE lot_id = ?', (lot_id,))
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç—É
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
        async with db.execute('SELECT count FROM user_cards WHERE user_id = ? AND card_id = ?', (user_id, card_id)) as c:
            exists = await c.fetchone()
            
        if exists:
            await db.execute('UPDATE user_cards SET count = count + 1 WHERE user_id = ? AND card_id = ?', (user_id, card_id))
        else:
            await db.execute('INSERT INTO user_cards (user_id, card_id, count) VALUES (?, ?, 1)', (user_id, card_id))
            
        await db.commit()
        
    await cb.answer("‚úÖ –õ–æ—Ç —É–¥–∞–ª–µ–Ω, –∫–∞—Ä—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞!")
    await show_market_page(cb, 0)

@dp.callback_query(F.data == "ignore")
async def ignore_click(cb: CallbackQuery):
    await cb.answer()

# –ü–æ–∫—É–ø–∫–∞ –ª–æ—Ç–∞
@dp.callback_query(F.data.startswith("buy_lot_"))
async def buy_lot(cb: CallbackQuery):
    lot_id = int(cb.data.split("_")[2])
    buyer_id = cb.from_user.id
    
    async with aiosqlite.connect(DB_NAME) as db:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ—Ç (–Ω–µ –∫—É–ø–∏–ª–∏ –ª–∏ –µ–≥–æ —É–∂–µ)
        async with db.execute('SELECT seller_id, card_id, price FROM market WHERE lot_id = ?', (lot_id,)) as c:
            lot = await c.fetchone()
            
        if not lot:
            await cb.answer("‚ùå –õ–æ—Ç —É–∂–µ –∫—É–ø–ª–µ–Ω –∏–ª–∏ —É–¥–∞–ª–µ–Ω!", show_alert=True)
            try: await cb.message.delete() # –£–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            except: pass
            return
            
        seller_id, card_id, price = lot
        
        if buyer_id == seller_id:
            await cb.answer("ü§® –¢—ã –Ω–µ –º–æ–∂–µ—à—å –∫—É–ø–∏—Ç—å —É —Å–∞–º–æ–≥–æ —Å–µ–±—è!")
            return

        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–Ω—å–≥–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
        async with db.execute('SELECT tomatoes FROM users WHERE user_id = ?', (buyer_id,)) as c:
            buyer_tom = (await c.fetchone())[0]
            
        if buyer_tom < price:
            await cb.answer(f"‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–æ–º–∏–¥–æ—Ä–æ–≤! –ù—É–∂–Ω–æ {price}", show_alert=True)
            return

        # --- –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø ---
        # –°–ø–∏—Å—ã–≤–∞–µ–º —É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
        await db.execute('UPDATE users SET tomatoes = tomatoes - ? WHERE user_id = ?', (price, buyer_id))
        
        # –ù–∞—á–∏—Å–ª—è–µ–º –ø—Ä–æ–¥–∞–≤—Ü—É
        # (–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ª–æ–≥ —Ä—ã–Ω–∫–∞ 10% –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤–∞–ª—é—Ç—ã –∏–∑ –∏–≥—Ä—ã: int(price * 0.9))
        await db.execute('UPDATE users SET tomatoes = tomatoes + ? WHERE user_id = ?', (price, seller_id))
        
        # –í—ã–¥–∞–µ–º –∫–∞—Ä—Ç—É –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∫–∞—Ä—Ç–∞ —É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
        async with db.execute('SELECT count FROM user_cards WHERE user_id = ? AND card_id = ?', (buyer_id, card_id)) as c:
            exists = await c.fetchone()
        
        if exists:
            await db.execute('UPDATE user_cards SET count = count + 1 WHERE user_id = ? AND card_id = ?', (buyer_id, card_id))
        else:
            await db.execute('INSERT INTO user_cards (user_id, card_id, count) VALUES (?, ?, 1)', (buyer_id, card_id))
            
        # –£–¥–∞–ª—è–µ–º –ª–æ—Ç
        await db.execute('DELETE FROM market WHERE lot_id = ?', (lot_id,))
        
        await db.commit()
        
    await cb.answer("‚úÖ –£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ!")
    await cb.message.answer(f"üéâ –¢—ã –∫—É–ø–∏–ª <b>{CARDS[card_id]['name']}</b> –∑–∞ {price} üçÖ!", parse_mode="HTML")
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–æ–¥–∞–≤—Ü–∞ (–µ—Å–ª–∏ –±–æ—Ç –Ω–µ –≤ –±–∞–Ω–µ)
    try:
        await bot.send_message(seller_id, f"ü§ë –¢–≤–æ–π –ª–æ—Ç <b>{CARDS[card_id]['name']}</b> –∫—É–ø–∏–ª–∏ –∑–∞ {price} üçÖ!")
    except: pass

# –í —Å–µ–∫—Ü–∏–∏ FSM
class AdminStates(StatesGroup):
    waiting_for_broadcast = State()
    
# –ü—Ä–æ—Å—Ç–∞—è –ø–∞—Å—Ö–∞–ª–∫–∞ –Ω–∞ —Ç–µ–∫—Å—Ç
@dp.message(F.text.lower().contains("—è —á–∏—Ç–µ—Ä"))
async def easter_egg_1(message: types.Message):
    await message.answer("üëÄ <b>–Ø —Å–ª–µ–∂—É –∑–∞ —Ç–æ–±–æ–π...</b>\n–ê–¥–º–∏–Ω—ã —É–∂–µ –≤—ã–µ—Ö–∞–ª–∏.", parse_mode="HTML")

@dp.message(F.text.lower().contains("—Ö–æ—á—É –¥–µ–Ω–µ–≥"))
async def easter_egg_2(message: types.Message):
    # –î–∞–µ–º 1 –ø–æ–º–∏–¥–æ—Ä
    user = await get_user(message.from_user.id)
    await update_stat(message.from_user.id, "tomatoes", user[3] + 1)
    await message.answer("üçÖ –î–µ—Ä–∂–∏ –ø–æ–º–∏–¥–æ—Ä–∫—É, –±–µ–¥–Ω—è–∫.")

@dp.message(F.text == "sudo rm -rf /")
async def easter_egg_linux(message: types.Message):
    await message.answer("ü§ñ <i>Kernel panic... System failure...</i>\n\n–®—É—á—É. –ù–µ –ª–æ–º–∞–π –º–µ–Ω—è.", parse_mode="HTML")

# --- –ë–î: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ú–ò–ì–†–ê–¶–ò–ò ---
async def init_db():
    async with aiosqlite.connect(DB_NAME) as db:
        # –ë–∞–∑–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–µ—Å–ª–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –Ω—É–ª—è)
        await db.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                milk INTEGER DEFAULT 0,
                tomatoes INTEGER DEFAULT 0,
                click_level INTEGER DEFAULT 1,
                tomato_level INTEGER DEFAULT 1, 
                fertilizer INTEGER DEFAULT 0,
                sosi_count INTEGER DEFAULT 0,
                is_banned INTEGER DEFAULT 0,
                luck_level INTEGER DEFAULT 0,
                safety_level INTEGER DEFAULT 0,
                eco_level INTEGER DEFAULT 0,
                casino_level INTEGER DEFAULT 0,
                gmo_level INTEGER DEFAULT 0
            )
        ''')
        # 1. –¢–∞–±–ª–∏—Ü–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∫–∞—Ä—Ç (–∫—Ç–æ –≤–ª–∞–¥–µ–µ—Ç, –∫–∞–∫–∞—è –∫–∞—Ä—Ç–∞, —Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫)
        await db.execute('''
            CREATE TABLE IF NOT EXISTS user_cards (
                user_id INTEGER,
                card_id TEXT,
                count INTEGER DEFAULT 0,
                PRIMARY KEY (user_id, card_id)
            )
        ''')
        
        # 2. –¢–∞–±–ª–∏—Ü–∞ –†–´–ù–ö–ê (–∫—Ç–æ –ø—Ä–æ–¥–∞–µ—Ç, —á—Ç–æ, –ø–æ—á–µ–º, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ª–æ—Ç–∞)
        await db.execute('''
            CREATE TABLE IF NOT EXISTS market (
                lot_id INTEGER PRIMARY KEY AUTOINCREMENT,
                seller_id INTEGER,
                seller_name TEXT,
                card_id TEXT,
                price INTEGER
            )
        ''')
        
        # –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è user_cards –Ω–µ –Ω—É–∂–Ω—ã, –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–æ–≤–∞—è.
        await db.commit()
        # –ú–∏–≥—Ä–∞—Ü–∏–∏: –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ —Å—Ç–∞—Ä—É—é –±–∞–∑—É, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        new_columns = [
            ("luck_level", "INTEGER DEFAULT 0"),   # –£–¥–∞—á–∞ (—à–∞–Ω—Å –¥—Ä–æ–ø–∞)
            ("safety_level", "INTEGER DEFAULT 0"), # –ö—Ä—ã—à–∫–∞ (–∞–Ω—Ç–∏-—Ä–∞–∑–ª–∏–≤)
            ("eco_level", "INTEGER DEFAULT 0"),    # –ù–∞—Å–æ—Å (–¥–µ—à–µ–≤–ª–µ –ø–æ–ª–∏–≤)
            ("casino_level", "INTEGER DEFAULT 0"), # –®—É–ª–µ—Ä (–¥–µ—à–µ–≤–ª–µ –∫–∞–∑–∏–Ω–æ)
            ("gmo_level", "INTEGER DEFAULT 0"),     # –ì–ú–û (–∫—ç—à–±–µ–∫ –º–æ–ª–æ–∫–∞)
            ("last_daily_claim", "REAL DEFAULT 0"),
            ("reg_date", "REAL DEFAULT 0"),
            ("last_scarecrow", "REAL DEFAULT 0"),    # –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏–≥—Ä—ã —Å –ø—É–≥–∞–ª–æ–º
            ("active_boost", "TEXT DEFAULT ''"),     # –¢–∏–ø –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±—É—Å—Ç–∞ (milk_x2, water_free –∏ —Ç.–¥.)
            ("boost_end", "REAL DEFAULT 0"),          # –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –±—É—Å—Ç–∞
            ("mandarins", "INTEGER DEFAULT 0"),
            ("prefix", "TEXT DEFAULT NULL"),        # –ü—Ä–µ—Ñ–∏–∫—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä [VIP])
            ("custom_status", "TEXT DEFAULT '–§–µ—Ä–º–µ—Ä'"), # –°—Ç–∞—Ç—É—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ
            ("is_admin", "INTEGER DEFAULT 0"),   # 1 - –∞–¥–º–∏–Ω, 0 - –Ω–µ—Ç
            ("last_active", "REAL DEFAULT 0")    # –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        ]
        
        for col, definition in new_columns:
            try:
                await db.execute(f'ALTER TABLE users ADD COLUMN {col} {definition}')
            except:
                pass # –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ –µ—Å—Ç—å
        # –î–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ—Å—Ç–∞–≤–∏–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è, –µ—Å–ª–∏ —Ç–∞–º 0
        current_time = time.time()
        await db.execute(f'UPDATE users SET reg_date = ? WHERE reg_date = 0', (current_time,))
        await db.commit()

async def get_user(user_id):
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT * FROM users WHERE user_id = ?', (user_id,)) as cursor:
            user = await cursor.fetchone()
            if not user:
                # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
                await db.execute('INSERT INTO users (user_id, username, reg_date) VALUES (?, ?, ?)',
                                 (user_id, "Newbie", time.time()))
                await db.commit()
                return await get_user(user_id) # –†–µ–∫—É—Ä—Å–∏—è —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –ø–æ–ª–Ω—ã–π —Ä—è–¥
            return user

async def update_username(user_id, name):
    async with aiosqlite.connect(DB_NAME) as db:
        await db.execute('UPDATE users SET username = ? WHERE user_id = ?', (name, user_id))
        await db.commit()

async def update_stat(user_id, column, value):
    async with aiosqlite.connect(DB_NAME) as db:
        await db.execute(f'UPDATE users SET {column} = ? WHERE user_id = ?', (value, user_id))
        await db.commit()

def get_shop_text(user):
    # user[3] - —ç—Ç–æ –ø–æ–º–∏–¥–æ—Ä—ã
    
    return (
        f"üè™ <b>–ù–æ–≤–æ–≥–æ–¥–Ω—è—è –õ–∞–≤–∫–∞</b>\n"
        f"–í–∞—à –±–∞–ª–∞–Ω—Å: <code>{format_num(user[3])}</code> üçÖ\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"<b>üìã –û–ü–ò–°–ê–ù–ò–ï –¢–û–í–ê–†–û–í:</b>\n\n"
        f"üí™ <b>–ë–∏—Ü–µ–ø—Å:</b> –ë–æ–ª—å—à–µ –º–æ–ª–æ–∫–∞ –∑–∞ –æ–¥–∏–Ω –∫–ª–∏–∫ (+1)\n"
        f"üß¨ <b>–°–æ—Ä—Ç:</b> –í—ã—à–µ —à–∞–Ω—Å —Å–æ–±—Ä–∞—Ç—å –¥–≤–æ–π–Ω–æ–π —É—Ä–æ–∂–∞–π (x2)\n"
        f"üçÄ <b>–£–¥–∞—á–∞:</b> –ß–∞—â–µ –≤—ã–ø–∞–¥–∞–µ—Ç —Ö–∏–º–∏—è –∏ –±–æ–Ω—É—Å—ã –ø—Ä–∏ –¥–æ–π–∫–µ\n"
        f"üõ° <b>–ö—Ä—ã—à–∫–∞:</b> –°–Ω–∏–∂–∞–µ—Ç —à–∞–Ω—Å –ø—Ä–æ–ª–∏—Ç—å –º–æ–ª–æ–∫–æ –º–∏–º–æ –≤–µ–¥—Ä–∞\n"
        f"üìâ <b>–ù–∞—Å–æ—Å:</b> –°–Ω–∏–∂–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥ –º–æ–ª–æ–∫–∞ –Ω–∞ –ø–æ–ª–∏–≤ –≥—Ä—è–¥–∫–∏\n"
        f"üÉè <b>–®—É–ª–µ—Ä:</b> –°–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å–ª–æ—Ç–æ–≤\n"
        f"üß™ <b>–ì–ú–û:</b> –®–∞–Ω—Å –≤–µ—Ä–Ω—É—Ç—å 50% –º–æ–ª–æ–∫–∞ –ø–æ—Å–ª–µ –ø–æ–ª–∏–≤–∞\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"üëá <b>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∫—É–ø–∏—Ç—å:</b>"
    )

# --- –ö–†–ê–°–ò–í–´–ô –î–ò–ó–ê–ô–ù –ö–õ–ê–í–ò–ê–¢–£–† ---
def main_keyboard():
    kb = [
        # –û—Å–Ω–æ–≤–Ω–æ–π –≥–µ–π–º–ø–ª–µ–π –≤—Å–µ–≥–¥–∞ –ø–æ–¥ —Ä—É–∫–æ–π
        [KeyboardButton(text="‚ùÑÔ∏è –¢—Ä—è—Å—Ç–∏ –µ–ª–∫—É (–î–æ–∏—Ç—å)"), KeyboardButton(text="‚õÑÔ∏è –õ–µ–ø–∏—Ç—å —Å–Ω–µ–≥–æ–≤–∏–∫–∞ (–ü–æ–ª–∏—Ç—å)")],
        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        [KeyboardButton(text="üè∞ –ì–æ—Ä–æ–¥"), KeyboardButton(text="üé° –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è")],
        # –ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–¥–µ–ª—å–Ω–æ
        [KeyboardButton(text="üë§ –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å")]
    ]
    return ReplyKeyboardMarkup(keyboard=kb, resize_keyboard=True, input_field_placeholder="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")

def town_keyboard():
    kb = [
        [KeyboardButton(text="üéÖ –õ–∞–≤–∫–∞ –°–∞–Ω—Ç—ã"), KeyboardButton(text="üéí –°–∫–ª–∞–¥")],
        [KeyboardButton(text="üèÜ –õ–∏–¥–µ—Ä—ã"), KeyboardButton(text="üìü –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥")],
        [KeyboardButton(text="üîô –ù–∞–∑–∞–¥")]
    ]
    return ReplyKeyboardMarkup(keyboard=kb, resize_keyboard=True, input_field_placeholder="–†–∞–π–æ–Ω: –ì–æ—Ä–æ–¥")

def fun_keyboard():
    kb = [
        [KeyboardButton(text="üé≤ –ö—Ä—É—Ç–∏—Ç—å —Å–ª–æ—Ç"), KeyboardButton(text="üéÅ –ü–æ–¥–∞—Ä–æ–∫ (–ï–∂–µ–¥–Ω.)")],
        [KeyboardButton(text="üë∫ –ì—Ä–∏–Ω—á (–ò–≤–µ–Ω—Ç)")],
        [KeyboardButton(text="üîô –ù–∞–∑–∞–¥")]
    ]
    return ReplyKeyboardMarkup(keyboard=kb, resize_keyboard=True, input_field_placeholder="–†–∞–π–æ–Ω: –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è")

def upgrades_keyboard(u):
    # u - —ç—Ç–æ row –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò–Ω–¥–µ–∫—Å—ã:
    # 4-Click, 5-Tomato, 9-Luck, 10-Safety, 11-Eco, 12-Casino, 13-GMO
    
    # –†–∞—Å—á–µ—Ç —Ü–µ–Ω (—Ñ–æ—Ä–º—É–ª—ã)
    p_click = 10 * u[4]
    p_tomato = 50 * u[5]
    p_luck = 30 * (u[9] + 1)
    p_safe = 25 * (u[10] + 1)
    p_eco = 100 * (u[11] + 1)
    p_cas = 40 * (u[12] + 1)
    p_gmo = 75 * (u[13] + 1)

    kb = [
        [InlineKeyboardButton(text=f"üí™ –ë–∏—Ü–µ–ø—Å ({p_click}üçÖ)", callback_data="buy_click"),
         InlineKeyboardButton(text=f"üß¨ –°–æ—Ä—Ç ({p_tomato}üçÖ)", callback_data="buy_tomato")],
        
        [InlineKeyboardButton(text=f"üçÄ –£–¥–∞—á–∞ ({p_luck}üçÖ)", callback_data="buy_luck"),
         InlineKeyboardButton(text=f"üõ° –ö—Ä—ã—à–∫–∞ ({p_safe}üçÖ)", callback_data="buy_safe")],
         
        [InlineKeyboardButton(text=f"üìâ –ù–∞—Å–æ—Å ({p_eco}üçÖ)", callback_data="buy_eco"),
         InlineKeyboardButton(text=f"üÉè –®—É–ª–µ—Ä ({p_cas}üçÖ)", callback_data="buy_cas")],
         
        [InlineKeyboardButton(text=f"üß™ –ì–ú–û ({p_gmo}üçÖ)", callback_data="buy_gmo")],
        
        [InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã", callback_data="refresh_upgrades")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=kb)

def inventory_keyboard(has_fert):
    kb = []
    if has_fert:
        kb.append([InlineKeyboardButton(text="üß™ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ö–∏–º–∏—é (+5üçÖ)", callback_data="use_fertilizer")])
    kb.append([InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="refresh_inv")])
    return InlineKeyboardMarkup(inline_keyboard=kb)

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ---
async def delete_later(msg, delay=2):
    await asyncio.sleep(delay)
    try: await msg.delete()
    except: pass

def format_num(num):
    return "{:,}".format(num).replace(",", " ")

def get_progress_bar(value, max_value=10):
    # –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞
    percent = min(1.0, value / max_value)
    blocks = int(percent * 10)
    return "‚ñì" * blocks + "‚ñë" * (10 - blocks)

@dp.callback_query(F.data == "check_subscription")
async def check_subscription_handler(cb: CallbackQuery):
    # –ï—Å–ª–∏ –∫–æ–¥ –¥–æ—à–µ–ª —Å—é–¥–∞, –∑–Ω–∞—á–∏—Ç Middleware –ø—Ä–æ–ø—É—Å—Ç–∏–ª —é–∑–µ—Ä–∞ (–æ–Ω –ø–æ–¥–ø–∏—Å–∞–Ω)
    await cb.message.delete() # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∫–∏
    await cb.answer("‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É! –ü—Ä–∏—è—Ç–Ω–æ–π –∏–≥—Ä—ã!")
    
    # –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    await cb.message.answer("üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –§–µ—Ä–º—É! –ñ–º–∏ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.", reply_markup=main_keyboard())

# --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    user = await get_user(message.from_user.id)
    if user[8]: return # Ban

    caption = (
        f"üåæ <b>–§–µ—Ä–º–∞ v7.0(–°—Ç–∞–±–∏–ª—å–Ω–∞—è) </b>\n\n"
        f"–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!\n"
        f"–ú—ã –∑–∞–≤–µ–∑–ª–∏ –Ω–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏. –¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –∫–∞—á–∞—Ç—å —É–¥–∞—á—É, —ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –ø–æ–ª–∏–≤–µ –∏ –¥–∞–∂–µ –º—É—Ö–ª–µ–≤–∞—Ç—å –≤ –∫–∞–∑–∏–Ω–æ!\n\n"
        f"üëá <b>–ù–∞—á–∏–Ω–∞–π —Ä–∞–±–æ—Ç—É:</b>"
    )
    
    try:
        photo = FSInputFile(LOGO_PATH)
        await message.answer_photo(photo, caption=caption, reply_markup=main_keyboard(), parse_mode="HTML")
    except:
        await message.answer_photo(DEFAULT_LOGO_URL, caption=caption, reply_markup=main_keyboard(), parse_mode="HTML")

# --- –î–û–ô–ö–ê (–° –£–ß–ï–¢–û–ú –ù–û–í–´–• –°–¢–ê–¢–û–í) ---
@dp.message(F.text.in_({"üêÆ –ñ–º—è–∫–Ω—É—Ç—å –≤—ã–º—è", "‚ùÑÔ∏è –¢—Ä—è—Å—Ç–∏ –µ–ª–∫—É (–î–æ–∏—Ç—å)"}))
async def milk_handler(message: types.Message):
    # –£–ë–†–ê–õ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞, —á—Ç–æ–±—ã –Ω–µ –º–µ–ª—å–∫–∞–ª–æ
    # try: await message.delete()
    # except: pass
    
    user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –±—É—Å—Ç—ã
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT * FROM users WHERE user_id = ?', (user_id,)) as c:
            user = await c.fetchone()
        async with db.execute('SELECT active_boost, boost_end FROM users WHERE user_id = ?', (user_id,)) as c:
            b_row = await c.fetchone()
            active_boost = b_row[0] if b_row else ""
            boost_end = b_row[1] if b_row else 0

    is_boosted_milk = (time.time() < boost_end and active_boost == "milk_x2")
    is_boosted_luck = (time.time() < boost_end and active_boost == "luck_max")

    base_milk = MILK_PER_CLICK * user[4]
    if is_boosted_milk: base_milk *= 2

    drop_chance = 1.0 if is_boosted_luck else (0.15 + (user[9] * 0.02))
    spill_chance = max(0, 0.05 - (user[10] * 0.01))

    rand = random.random()
    boost_icon = "‚ö°Ô∏èx2 " if is_boosted_milk else ""
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    if rand < spill_chance:
        lost = max(1, int(user[2] * 0.1))
        await update_stat(user_id, "milk", max(0, user[2] - lost))
        text = f"üí¢ <b>–ß–µ—Ä—Ç!</b> –¢—ã –ø—Ä–æ–ª–∏–ª {lost} –ª. (–ö–∞—á–∞–π ¬´–ö—Ä—ã—à–∫—É¬ª!)"
    
    elif rand > (1 - drop_chance):
        await update_stat(user_id, "fertilizer", user[6] + 1)
        await update_stat(user_id, "milk", user[2] + base_milk)
        text = f"ü•õ {boost_icon}+{base_milk} –ª.\nüéÅ <b>–ù–∞–π–¥–µ–Ω–∞ —Ö–∏–º–∏—è!</b>"
    
    else:
        await update_stat(user_id, "milk", user[2] + base_milk)
        text = f"ü•õ –ü—à—à... {boost_icon}+{base_milk} –ª."

    # –û–¢–ü–†–ê–í–õ–Ø–ï–ú –°–û–û–ë–©–ï–ù–ò–ï –ò –Ø–í–ù–û –ü–†–ò–ö–†–ï–ü–õ–Ø–ï–ú –ö–õ–ê–í–ò–ê–¢–£–†–£
    # –ò —Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ - –ù–ï –£–î–ê–õ–Ø–ï–ú –ï–ì–û –ü–û–¢–û–ú
    await message.answer(text, reply_markup=main_keyboard(), parse_mode="HTML")

# --- –ü–û–õ–ò–í (–° –£–ß–ï–¢–û–ú –≠–ö–û–ù–û–ú–ò–ò –ò –ì–ú–û) ---
@dp.message(F.text.in_({"üí¶ –ü–æ–ª–∏—Ç—å –≥—Ä—è–¥–∫—É", "‚õÑÔ∏è –õ–µ–ø–∏—Ç—å —Å–Ω–µ–≥–æ–≤–∏–∫–∞ (–ü–æ–ª–∏—Ç—å)"}))
async def plant_handler(message: types.Message):
    # –£–ë–†–ê–õ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
    # try: await message.delete()
    # except: pass
    
    user_id = message.from_user.id
    user = await get_user(user_id)
    
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT active_boost, boost_end FROM users WHERE user_id = ?', (user_id,)) as c:
            b_row = await c.fetchone()
            active_boost = b_row[0] if b_row else ""
            boost_end = b_row[1] if b_row else 0

    is_boosted_tom = (time.time() < boost_end and active_boost == "tomato_x2")
    is_free_water = (time.time() < boost_end and active_boost == "water_free")

    cost = 0 if is_free_water else int(max(1, BASE_PLANT_COST - (user[11] * 0.5)))
    
    if user[2] >= cost:
        crit_chance = user[5] * 0.05
        base_yield = 2 if random.random() < crit_chance else 1
        if is_boosted_tom: base_yield *= 2
        
        refund_text = ""
        real_cost = cost
        if not is_free_water and cost > 0:
            gmo_chance = user[13] * 0.05
            if random.random() < gmo_chance:
                refund = int(cost * 0.5)
                real_cost = cost - refund
                refund_text = f"\n‚ôªÔ∏è <b>–ì–ú–û!</b> –í–æ–∑–≤—Ä–∞—Ç {refund} –ª."

        await update_stat(user_id, "milk", user[2] - real_cost)
        await update_stat(user_id, "tomatoes", user[3] + base_yield)
        
        boost_msg = "‚ö°Ô∏èx2 " if is_boosted_tom else ""
        free_msg = " (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ!)" if is_free_water else f" (-{real_cost} –ª.)"
        
        text = f"üçÖ {boost_msg}–£—Ä–æ–∂–∞–π: +{base_yield} —à—Ç.{free_msg}{refund_text}"
    else:
        text = f"üíß –ù—É–∂–Ω–æ {cost} –ª. –º–æ–ª–æ–∫–∞! (–ö–∞—á–∞–π ¬´–ù–∞—Å–æ—Å¬ª)"
    
    # –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ò –ù–ï –£–î–ê–õ–Ø–ï–ú
    await message.answer(text, reply_markup=main_keyboard(), parse_mode="HTML")

    # –ù–û–í–û–ì–û–î–ù–ò–ô –î–†–û–ü
    mandarin_drop = ""
    if random.random() < 0.30: # 30% —à–∞–Ω—Å
        mandarins_found = random.randint(1, 3)
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –º–∞–Ω–¥–∞—Ä–∏–Ω—ã (–ª—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ user)
        # –ù–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ —Å–¥–µ–ª–∞–µ–º –±—ã—Å—Ç—Ä—ã–π update:
        current_mandarins = (await get_user(message.from_user.id))[15] # –ü—Ä–æ–≤–µ—Ä—å –∏–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏! –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π SELECT mandarins
        await update_stat(message.from_user.id, "mandarins", current_mandarins + mandarins_found)
        mandarin_drop = f"\nüçä <b>–ù–∞–π–¥–µ–Ω–æ –º–∞–Ω–¥–∞—Ä–∏–Ω–æ–≤: {mandarins_found} —à—Ç!</b>"
        
    # –ï—Å–ª–∏ –º–∞–Ω–¥–∞—Ä–∏–Ω—ã –≤—ã–ø–∞–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if mandarin_drop:
        await message.answer(f"üéâ –°—é—Ä–ø—Ä–∏–∑ –≤ —Å—É–≥—Ä–æ–±–µ!{mandarin_drop}", reply_markup=main_keyboard())


# --- –°–ò–°–¢–ï–ú–ê –¢–û–ü–û–í ---

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (–∏–∑ —Å–µ–∫—É–Ω–¥ –≤ –¥–Ω–∏/—á–∞—Å—ã)
def format_time_spent(seconds_played):
    days = int(seconds_played // 86400)
    hours = int((seconds_played % 86400) // 3600)
    if days > 0:
        return f"{days} –¥. {hours} —á."
    return f"{hours} —á. {int((seconds_played % 3600) // 60)} –º–∏–Ω."

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∫–Ω–æ–ø–æ–∫
async def get_leaderboard_data(top_type="tomatoes"):
    # top_type –º–æ–∂–µ—Ç –±—ã—Ç—å: 'tomatoes', 'milk', 'time'
    
    async with aiosqlite.connect(DB_NAME) as db:
        if top_type == "tomatoes":
            query = 'SELECT username, tomatoes FROM users ORDER BY tomatoes DESC LIMIT 10'
            title = "üçÖ –¢–û–ü –ú–ê–ì–ù–ê–¢–û–í (–ü–æ–º–∏–¥–æ—Ä—ã)"
            metric_suffix = " üçÖ"
            prev_type, next_type = "time", "milk" # –°—Ç—Ä–µ–ª–∫–∏
            
        elif top_type == "milk":
            query = 'SELECT username, milk FROM users ORDER BY milk DESC LIMIT 10'
            title = "ü•õ –¢–û–ü –î–û–Ø–†–û–ö (–ú–æ–ª–æ–∫–æ)"
            metric_suffix = " –ª."
            prev_type, next_type = "tomatoes", "time"
            
        elif top_type == "time":
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ reg_date ASC (–∫—Ç–æ —Ä–∞–Ω—å—à–µ –∑–∞—Ä–µ–≥–∞–ª—Å—è - —É —Ç–æ–≥–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏)
            query = 'SELECT username, reg_date FROM users ORDER BY reg_date ASC LIMIT 10'
            title = "‚è≥ –¢–û–ü –û–õ–î–û–í (–í –∏–≥—Ä–µ)"
            metric_suffix = ""
            prev_type, next_type = "milk", "tomatoes"

        async with db.execute(query) as c:
            res = await c.fetchall()

    text = f"üèÜ <b>{title}</b>\n\n"
    
    if not res:
        text += "<i>–ü–æ–∫–∞ –ø—É—Å—Ç–æ...</i>"
    
    current_time = time.time()
    
    for i, row in enumerate(res):
        name = row[0]
        value = row[1]
        
        # –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π
        if top_type == "time":
            # –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            val_str = format_time_spent(current_time - value)
        else:
            val_str = f"{format_num(value)}{metric_suffix}"
            
        # –ú–µ–¥–∞–ª–∏ –¥–ª—è —Ç–æ–ø 3
        medal = "ü•á" if i == 0 else "ü•à" if i == 1 else "ü•â" if i == 2 else f"{i+1}."
        
        text += f"{medal} <b>{name}</b> ‚Äî {val_str}\n"

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="‚¨ÖÔ∏è", callback_data=f"top_{prev_type}"),
            InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"top_{top_type}"),
            InlineKeyboardButton(text="‚û°Ô∏è", callback_data=f"top_{next_type}")
        ]
    ])
    
    return text, kb

# --- –ö–ê–ó–ò–ù–û (–° –£–ß–ï–¢–û–ú –®–£–õ–ï–†–ê) ---
@dp.message(F.text == "üé≤ –ö—Ä—É—Ç–∏—Ç—å —Å–ª–æ—Ç")
async def casino_handler(message: types.Message):
    user = await get_user(message.from_user.id)
    # Stats: 12-CasinoLvl
    
    # –°—Ç–∞–≤–∫–∞: –ë–∞–∑–∞ 10 - 1 –∑–∞ —É—Ä–æ–≤–µ–Ω—å –®—É–ª–µ—Ä–∞ (–ú–∏–Ω 2)
    bet = max(2, BASE_CASINO_COST - user[12])
    
    if user[3] < bet:
        msg = await message.answer(f"‚ùå –°—Ç–∞–≤–∫–∞ {bet} –ø–æ–º–∏–¥–æ—Ä–æ–≤. –£ —Ç–µ–±—è –º–∞–ª–æ!")
        asyncio.create_task(delete_later(msg))
        return

    await update_stat(message.from_user.id, "tomatoes", user[3] - bet)
    dice_msg = await message.answer_dice(emoji="üé∞")
    await asyncio.sleep(2)
    
    # –õ–æ–≥–∏–∫–∞ —Å–ª–æ—Ç–∞ (–∑–Ω–∞—á–µ–Ω–∏–µ dice.value –æ—Ç 1 –¥–æ 64)
    val = dice_msg.dice.value
    win = 0
    
    # 1, 22, 43, 64 - —ç—Ç–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
    # –£–ø—Ä–æ—Å—Ç–∏–º: Value –≤ dice üé∞: 
    # 1=bar, 22=grapes, 43=lemon, 64=seven (Jackpot)
    
    if val == 64: # –¢—Ä–∏ —Å–µ–º–µ—Ä–∫–∏
        win = bet * 10
        res = f"ü§ë <b>–î–ñ–ï–ö–ü–û–¢!!!</b> (+{win})"
    elif val == 43: # –¢—Ä–∏ –ª–∏–º–æ–Ω–∞
        win = bet * 3
        res = f"üçã <b>–°–æ—á–Ω–æ!</b> (+{win})"
    elif val == 22: # –í–∏–Ω–æ–≥—Ä–∞–¥
        win = bet * 2
        res = f"üçá <b>–í–∫—É—Å–Ω–æ!</b> (+{win})"
    elif val == 1: # –ë–∞—Ä
        win = bet
        res = f"üòê <b>–í–æ–∑–≤—Ä–∞—Ç.</b> (+{win})"
    else:
        res = f"üìâ <b>–ú–∏–º–æ.</b> (-{bet})"
    
    if win > 0:
        await update_stat(message.from_user.id, "tomatoes", (user[3] - bet) + win)
    
    await message.answer(res, parse_mode="HTML")

# --- –ú–ê–ì–ê–ó–ò–ù (–•–ï–ù–î–õ–ï–†–´ –ù–û–í–´–• –ü–û–ö–£–ü–û–ö) ---
@dp.message(F.text.in_({"‚ö°Ô∏è –ú–∞–≥–∞–∑–∏–Ω", "üéÖ –õ–∞–≤–∫–∞ –°–∞–Ω—Ç—ã"}))
async def shop_menu(message: types.Message):
    user = await get_user(message.from_user.id)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ç–µ–∫—Å—Ç–∞
    text = get_shop_text(user)
    
    await message.answer(text, reply_markup=upgrades_keyboard(user), parse_mode="HTML")

@dp.callback_query(F.data.startswith("buy_"))
async def buy_upgrade(cb: CallbackQuery):
    type_up = cb.data.split("_")[1] # click, tomato, luck, safe, eco, cas, gmo
    user = await get_user(cb.from_user.id)
    tom = user[3]
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏ –∫–æ–ª–æ–Ω–∫–∏
    cost = 0
    col = ""
    new_lvl = 0
    
    if type_up == "click":
        cost = 10 * user[4]
        col = "click_level"
        new_lvl = user[4] + 1
    elif type_up == "tomato":
        cost = 50 * user[5]
        col = "tomato_level"
        new_lvl = user[5] + 1
    elif type_up == "luck":
        cost = 30 * (user[9] + 1)
        col = "luck_level"
        new_lvl = user[9] + 1
    elif type_up == "safe":
        cost = 25 * (user[10] + 1)
        col = "safety_level"
        new_lvl = user[10] + 1
    elif type_up == "eco":
        cost = 100 * (user[11] + 1)
        col = "eco_level"
        new_lvl = user[11] + 1
    elif type_up == "cas":
        cost = 40 * (user[12] + 1)
        col = "casino_level"
        new_lvl = user[12] + 1
    elif type_up == "gmo":
        cost = 75 * (user[13] + 1)
        col = "gmo_level"
        new_lvl = user[13] + 1

    if tom >= cost:
        await update_stat(cb.from_user.id, "tomatoes", tom - cost)
        await update_stat(cb.from_user.id, col, new_lvl)
        await cb.answer(f"‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ '{type_up.upper()}' –∫—É–ø–ª–µ–Ω–æ!")
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é
        u = await get_user(cb.from_user.id)
        try: await cb.message.edit_text(
            # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ—Ç –∂–µ –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç
                get_shop_text(u), 
                reply_markup=upgrades_keyboard(u), 
                parse_mode="HTML"
        )
        except: pass
    else:
        await cb.answer(f"‚ùå –ù—É–∂–Ω–æ {cost} –ø–æ–º–∏–¥–æ—Ä–æ–≤!", show_alert=True)

@dp.callback_query(F.data == "refresh_upgrades")
async def refresh_shop(cb: CallbackQuery):
    u = await get_user(cb.from_user.id)
    try: 
        await cb.message.edit_text(
            get_shop_text(u), 
            reply_markup=upgrades_keyboard(u), 
            parse_mode="HTML"
        )
    except: pass
    await cb.answer()

# --- –ü–†–û–§–ò–õ–¨ (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) ---
@dp.message(F.text == "üë§ –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å")
async def profile_new(m: types.Message):
    user = await get_user(m.from_user.id)
    # 4-Click, 5-Tom, 9-Luck, 10-Safe, 11-Eco, 12-Cas, 13-GMO
    # –ò–Ω–¥–µ–∫—Å—ã –º–æ–≥—É—Ç —Å–º–µ—Å—Ç–∏—Ç—å—Å—è, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏–ª–∏ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç—å SELECT *
    # –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –º—ã –¥–æ–±–∞–≤–∏–ª–∏ prefix –∏ custom_status –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏.
    
    # –ß—Ç–æ–±—ã –Ω–µ –≥–∞–¥–∞—Ç—å —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏, —Å–¥–µ–ª–∞–µ–º —Ç–æ—á–µ—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã:
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT prefix, custom_status FROM users WHERE user_id = ?', (m.from_user.id,)) as c:
            meta = await c.fetchone()
            prefix = meta[0]
            status = meta[1]

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
    display_name = m.from_user.full_name
    if prefix:
        display_name = f"<b>[{prefix}]</b> {display_name}"

    text = (
        f"üë§ <b>–ö–ê–†–¢–û–ß–ö–ê –§–ï–†–ú–ï–†–ê</b>\n"
        f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
        f"üè∑ –ò–º—è: {display_name}\n"
        f"üî∞ –°—Ç–∞—Ç—É—Å: <b>{status}</b>\n"
        f"üÜî <code>{user[0]}</code>\n\n"
        f"üì¶ <b>–†–ï–°–£–†–°–´:</b>\n"
        f"ü•õ –ú–æ–ª–æ–∫–æ: <b>{format_num(user[2])}</b>\n"
        f"üçÖ –ü–æ–º–∏–¥–æ—Ä—ã: <b>{format_num(user[3])}</b>\n"
        f"üçä –ú–∞–Ω–¥–∞—Ä–∏–Ω—ã: <b>{user[15]}</b>\n"
        f"üß™ –•–∏–º–∏—è: <b>{user[6]}</b>\n\n"
        f"üß¨ <b>–¢–ï–•–ù–û–õ–û–ì–ò–ò:</b>\n"
        f"üí™ –ë–∏—Ü–µ–ø—Å: {user[4]}\n"
        f"üß¨ –°–æ—Ä—Ç: {user[5]}\n"
        f"üçÄ –£–¥–∞—á–∞: {user[9]} {get_progress_bar(user[9], 20)}\n"
        f"üõ° –ö—Ä—ã—à–∫–∞: {user[10]} {get_progress_bar(user[10], 5)}\n"
        f"üìâ –ù–∞—Å–æ—Å: {user[11]} {get_progress_bar(user[11], 8)}\n"
        f"üÉè –®—É–ª–µ—Ä: {user[12]} {get_progress_bar(user[12], 10)}\n"
        f"üß™ –ì–ú–û: {user[13]} {get_progress_bar(user[13], 15)}"
    )
    await m.answer(text, parse_mode="HTML")

# --- –°–ö–õ–ê–î ---
# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –∫–∞—Ä—Ç (–±–µ–∑ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å)
@dp.message(F.text == "üé¥ –ö–∞—Ä—Ç–æ—á–∫–∏") # –ò–ª–∏ –¥–æ–±–∞–≤—å –∫–Ω–æ–ø–∫—É "üé¥ –ö–∞—Ä—Ç–æ—á–∫–∏" –≤ –º–µ–Ω—é
async def show_cards_list(message: types.Message):
    user_id = message.from_user.id
    
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT card_id, count FROM user_cards WHERE user_id = ? AND count > 0', (user_id,)) as c:
            my_cards = await c.fetchall()

    if not my_cards:
        await message.answer("üéí –¢–≤–æ–π –∞–ª—å–±–æ–º —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –ø—É—Å—Ç. –ö—É–ø–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –Ω–∞ —Ä—ã–Ω–∫–µ!")
        return

    text = "üéí <b>–¢–í–û–Ø –ö–û–õ–õ–ï–ö–¶–ò–Ø</b>\n<i>–ñ–º–∏ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞—Ä—Ç:</i>\n\n"
    kb_builder = []
    
    for card_id, count in my_cards:
        if card_id not in CARDS: continue
        
        card_data = CARDS[card_id]
        rarity_icon = RARITY_INFO[card_data["rarity"]]["icon"]
        
        # –ö–Ω–æ–ø–∫–∞: [ üü¢ –ê–ª—å—Ç—É—à–∫–∞ (x2) ] -> –ø–æ –∫–ª–∏–∫—É –ø–æ–∫–∞–∂–µ—Ç —Ñ–æ—Ç–æ
        btn_text = f"{rarity_icon} {card_data['name']} (x{count})"
        kb_builder.append([InlineKeyboardButton(text=btn_text, callback_data=f"show_card_{card_id}")])

    kb = InlineKeyboardMarkup(inline_keyboard=kb_builder)
    await message.answer(text, reply_markup=kb, parse_mode="HTML")

# –•–µ–Ω–¥–ª–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É –≤ —Å–ø–∏—Å–∫–µ
@dp.callback_query(F.data.startswith("show_card_"))
async def show_one_card_pic(cb: CallbackQuery):
    card_id = cb.data.split("_")[2]
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª-–≤–æ
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT count FROM user_cards WHERE user_id = ? AND card_id = ?', (cb.from_user.id, card_id)) as c:
            res = await c.fetchone()
            count = res[0] if res else 0

    await cb.answer() # –£–±–∏—Ä–∞–µ–º —á–∞—Å–∏–∫–∏
    await send_card_info(cb.message, card_id, count)

# --- –ê–î–ú–ò–ù –ò –ü–†–û–ß–ï–ï (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
@dp.message(F.text == "üèÜ –õ–∏–¥–µ—Ä—ã")
async def top_users_handler(m: Message):
    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ø –ø–æ –ø–æ–º–∏–¥–æ—Ä–∞–º
    text, kb = await get_leaderboard_data("tomatoes")
    await m.answer(text, reply_markup=kb, parse_mode="HTML")

@dp.callback_query(F.data.startswith("top_"))
async def top_navigation(cb: CallbackQuery):
    # –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø —Ç–æ–ø–∞ –∏–∑ data (–Ω–∞–ø—Ä–∏–º–µ—Ä, top_milk -> milk)
    top_type = cb.data.split("_")[1]
    
    text, kb = await get_leaderboard_data(top_type)
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (—á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –Ω–æ–≤—ã–º–∏)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º try-except, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
    try:
        await cb.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    except:
        pass
    await cb.answer()

@dp.message(F.text == "üìü –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥")
async def code_start(m: Message, state: FSMContext):
    await m.answer("–í–≤–µ–¥–∏ –∫–æ–¥:", reply_markup=types.ReplyKeyboardRemove())
    await state.set_state(GameStates.waiting_for_code)

@dp.message(StateFilter(GameStates.waiting_for_code))
async def code_proc(m: Message, state: FSMContext):
    if m.text == "winter":
        u = await get_user(m.from_user.id)
        if u[7] < 5:
            await update_stat(m.from_user.id, "milk", u[2] + 500)
            await update_stat(m.from_user.id, "winter_count", u[7] + 1)
            await m.answer("‚úÖ +500 –º–æ–ª–æ–∫–∞", reply_markup=main_keyboard())
        else: await m.answer("–õ–∏–º–∏—Ç", reply_markup=main_keyboard())
    else: await m.answer("–ù–µ–≤–µ—Ä–Ω–æ", reply_markup=main_keyboard())
    await state.clear()

async def set_menu(bot: Bot):
    await bot.set_my_commands([BotCommand(command='/start', description='–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é')])
# --- –•–ï–ù–î–õ–ï–†–´ –†–ê–°–°–´–õ–ö–ò ---

# --- –ï–ñ–ï–î–ù–ï–í–ù–´–ï –ù–ê–ì–†–ê–î–´ ---

@dp.message(F.text.in_({"üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å", "üéÅ –ü–æ–¥–∞—Ä–æ–∫ (–ï–∂–µ–¥–Ω.)"}))
async def daily_reward_menu(message: types.Message):
    user = await get_user(message.from_user.id)
    # user[14] - —ç—Ç–æ last_daily_claim (—Ç–∞–∫ –∫–∞–∫ –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –µ—ë –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤ –º–∏–≥—Ä–∞—Ü–∏–∏)
    # –ù–æ –Ω–∞–¥–µ–∂–Ω–µ–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—è–ª–∞—Å—å, –Ω–æ –ø–æ–∫–∞ –≤–æ–∑—å–º–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–º
    
    # –ß—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞—Ç—å—Å—è —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏, —Å–¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ–ª–µ–∫—Ç –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT last_daily_claim FROM users WHERE user_id = ?', (message.from_user.id,)) as c:
            res = await c.fetchone()
            last_claim = res[0] if res else 0

    now = time.time()
    elapsed = now - last_claim

    if elapsed < DAILY_COOLDOWN:
        # –ï—â–µ —Ä–∞–Ω–æ
        wait_time = DAILY_COOLDOWN - elapsed
        hours = int(wait_time // 3600)
        minutes = int((wait_time % 3600) // 60)
        await message.answer(f"‚è≥ <b>–°—É–Ω–¥—É–∫ –∑–∞–∫—Ä—ã—Ç –Ω–∞ –∑–∞–º–æ–∫!</b>\n–ü—Ä–∏—Ö–æ–¥–∏ —á–µ—Ä–µ–∑ {hours} —á. {minutes} –º–∏–Ω.", parse_mode="HTML")
        return

    # –ï—Å–ª–∏ –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ó–ê–ö–†–´–¢–´–ô —Å—É–Ω–¥—É–∫
    caption = "üéÅ <b>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å—É–Ω–¥—É–∫</b>\n–í–Ω—É—Ç—Ä–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–æ–ª–æ–∫–æ, –ø–æ–º–∏–¥–æ—Ä—ã –∏–ª–∏ –¥–∂–µ–∫–ø–æ—Ç!\n\nüëá –ñ–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å:"
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üîë –û—Ç–∫—Ä—ã—Ç—å —Å—É–Ω–¥—É–∫", callback_data="open_daily_chest")]
    ])

    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
        photo = FSInputFile(CHEST_CLOSE_PATH)
        await message.answer_photo(photo, caption=caption, reply_markup=kb, parse_mode="HTML")
    except:
        # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç - —à–ª–µ–º —Å—Å—ã–ª–∫—É
        await message.answer_photo(URL_CHEST_CLOSE, caption=caption, reply_markup=kb, parse_mode="HTML")


@dp.callback_query(F.data == "open_daily_chest")
async def open_chest_handler(cb: CallbackQuery):
    user_id = cb.from_user.id
    
    # –°–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è (–∑–∞—â–∏—Ç–∞ –æ—Ç –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–æ–≤/–±–∞–≥–æ–≤)
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT last_daily_claim FROM users WHERE user_id = ?', (user_id,)) as c:
            res = await c.fetchone()
            last_claim = res[0] if res else 0

    if time.time() - last_claim < DAILY_COOLDOWN:
        await cb.answer("‚ùå –¢—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª —Å—É–Ω–¥—É–∫ —Å–µ–≥–æ–¥–Ω—è!", show_alert=True)
        await cb.message.delete()
        return

    # --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ù–ê–ì–†–ê–î–´ ---
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –î–ñ–ï–ö–ü–û–¢ (1 –∫ 100 000)
    jackpot_roll = random.randint(1, JACKPOT_CHANCE)
    
    reward_text = ""
    is_jackpot = False
    
    if jackpot_roll == 777: # –°—á–∞—Å—Ç–ª–∏–≤–æ–µ —á–∏—Å–ª–æ
        is_jackpot = True
        prize_tomatoes = 1000000 # –ú–∏–ª–ª–∏–æ–Ω –ø–æ–º–∏–¥–æ—Ä–æ–≤
        
        # –ù–∞—á–∏—Å–ª—è–µ–º
        user = await get_user(user_id)
        await update_stat(user_id, "tomatoes", user[3] + prize_tomatoes)
        
        reward_text = (
            f"üò± <b>–î–ñ–ï–ö–ü–û–¢!!! –ù–ï–í–ï–†–û–Ø–¢–ù–û!!!</b> üò±\n"
            f"–¢–´ –í–´–ë–ò–õ 1 –ö {JACKPOT_CHANCE}!\n\n"
            f"üí∞ <b>–¢–≤–æ–π –ø—Ä–∏–∑:</b> {format_num(prize_tomatoes)} –ü–û–ú–ò–î–û–†–û–í!"
        )
    else:
        # –û–±—ã—á–Ω—ã–π –¥—Ä–æ–ø (—Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è)
        # –®–∞–Ω—Å—ã: 50% –ú–æ–ª–æ–∫–æ, 40% –ü–æ–º–∏–¥–æ—Ä—ã, 10% –•–∏–º–∏—è
        type_roll = random.random()
        user = await get_user(user_id)
        
        if type_roll < 0.5:
            # –ú–æ–ª–æ–∫–æ (–æ—Ç 100 –¥–æ 500)
            amount = random.randint(100, 500)
            await update_stat(user_id, "milk", user[2] + amount)
            reward_text = f"ü•õ –í–Ω—É—Ç—Ä–∏ –æ–∫–∞–∑–∞–ª–æ—Å—å <b>{amount} –ª. –º–æ–ª–æ–∫–∞</b>!"
            
        elif type_roll < 0.9:
            # –ü–æ–º–∏–¥–æ—Ä—ã (–æ—Ç 50 –¥–æ 200)
            amount = random.randint(50, 200)
            await update_stat(user_id, "tomatoes", user[3] + amount)
            reward_text = f"üçÖ –í–Ω—É—Ç—Ä–∏ –æ–∫–∞–∑–∞–ª–æ—Å—å <b>{amount} –ø–æ–º–∏–¥–æ—Ä–æ–≤</b>!"
            
        else:
            # –•–∏–º–∏—è (1-3 —à—Ç)
            amount = random.randint(1, 3)
            await update_stat(user_id, "fertilizer", user[6] + amount)
            reward_text = f"üß™ –†–µ–¥–∫–æ—Å—Ç—å! –¢—ã –Ω–∞—à–µ–ª <b>{amount} —à—Ç. —Ö–∏–º–∏–∏</b>!"

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è
    await update_stat(user_id, "last_daily_claim", time.time())

    # --- –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø (–û–¢–ö–†–´–¢–´–ô –°–£–ù–î–£–ö) ---
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π
    try: await cb.message.delete()
    except: pass
    
    final_caption = f"üîì <b>–°—É–Ω–¥—É–∫ –æ—Ç–∫—Ä—ã—Ç!</b>\n\n{reward_text}\n\n<i>–ü—Ä–∏—Ö–æ–¥–∏ –∑–∞–≤—Ç—Ä–∞ –∑–∞ –Ω–æ–≤–æ–π –Ω–∞–≥—Ä–∞–¥–æ–π!</i>"
    
    try:
        photo = FSInputFile(CHEST_OPEN_PATH)
        await cb.message.answer_photo(photo, caption=final_caption, parse_mode="HTML")
    except:
        await cb.message.answer_photo(URL_CHEST_OPEN, caption=final_caption, parse_mode="HTML")
        
    await cb.answer()

@dp.message(Command("broadcast"))
async def start_broadcast(message: types.Message, state: FSMContext):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞ (—É–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è ADMINS —É —Ç–µ–±—è –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤—ã—à–µ)
    if not message.from_user.username or message.from_user.username.lower() not in ADMINS:
        return
    
    await message.answer("üì¢ <b>–†–µ–∂–∏–º —Ä–∞—Å—Å—ã–ª–∫–∏</b>\n–ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å '–æ—Ç–º–µ–Ω–∞':", parse_mode="HTML")
    await state.set_state(AdminStates.waiting_for_broadcast)

@dp.message(StateFilter(AdminStates.waiting_for_broadcast))
async def process_broadcast(message: types.Message, state: FSMContext):
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–ª
    if message.text.lower() == "–æ—Ç–º–µ–Ω–∞":
        await message.answer("–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        await state.clear()
        return

    text_to_send = message.text
    await message.answer("üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É...")

    success_count = 0
    block_count = 0
    
    # –ë–µ—Ä–µ–º –≤—Å–µ—Ö —é–∑–µ—Ä–æ–≤ –∏–∑ –ë–î
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT user_id FROM users') as cursor:
            users = await cursor.fetchall()

    start_time = time.time()

    # –ü—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –≤—Å–µ–º
    for row in users:
        user_id = row[0]
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫—Ä–∞—Å–∏–≤—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
            await bot.send_message(user_id, f"üîî <b>–û–ë–™–Ø–í–õ–ï–ù–ò–ï</b>\n\n{text_to_send}", parse_mode="HTML")
            success_count += 1
            await asyncio.sleep(0.05) # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¢–µ–ª–µ–≥—Ä–∞–º –Ω–µ –∑–∞–±–∞–Ω–∏–ª –∑–∞ —Å–ø–∞–º
        except Exception:
            # –ï—Å–ª–∏ –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            block_count += 1

    duration = round(time.time() - start_time, 2)
    
    await message.answer(
        f"‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n"
        f"‚è± –í—Ä–µ–º—è: {duration} —Å–µ–∫.\n"
        f"üì© –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {success_count}\n"
        f"üö´ –ù–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ (–±–ª–æ–∫): {block_count}",
        parse_mode="HTML"
    )

    # --- –ò–í–ï–ù–¢ –ü–£–ì–ê–õ–û ---

@dp.message(F.text == "üë∫ –ì—Ä–∏–Ω—á (–ò–≤–µ–Ω—Ç)")
async def grinch_event(message: types.Message):
    # (–¢—É—Ç –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—É–ª–¥–∞—É–Ω–∞, —Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ scarecrow_menu)
    # –¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ì—Ä–∏–Ω—á–∞ –∏ —Ç–µ–∫—Å—Ç –¥—Ä—É–≥–æ–π:
    
    caption = (
        "üë∫ <b>–ì—Ä–∏–Ω—á –∫—Ä–∞–¥—ë—Ç –†–æ–∂–¥–µ—Å—Ç–≤–æ!</b>\n"
        "–≠—Ç–æ—Ç –∑–µ–ª–µ–Ω—ã–π –∑–ª–æ–¥–µ–π –ø—ã—Ç–∞–µ—Ç—Å—è —É—Ç–∞—â–∏—Ç—å —Ç–≤–æ–∏ –ø–æ–º–∏–¥–æ—Ä—ã!\n"
        "–ó–∞–∫–∏–¥–∞–π –µ–≥–æ —Å–Ω–µ–∂–∫–∞–º–∏, —á—Ç–æ–±—ã –æ—Ç–æ–≥–Ω–∞—Ç—å!"
    )
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ùÑÔ∏è –ö–ò–ù–£–¢–¨ –°–ù–ï–ñ–û–ö", callback_data="throw_snowball")]
    ])
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≥—Ä–∏–Ω—á–∞...
    await message.answer(caption, reply_markup=kb, parse_mode="HTML")

@dp.callback_query(F.data == "throw_snowball")
async def snowball_handler(cb: CallbackQuery):
    user_id = cb.from_user.id
    now = time.time()
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞ (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ)
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT last_scarecrow FROM users WHERE user_id = ?', (user_id,)) as c:
            last = (await c.fetchone())[0]
            
    if now - last < SCARECROW_COOLDOWN:
        await cb.answer("‚è≥ –ì—Ä–∏–Ω—á –µ—â–µ –Ω–µ –≤–µ—Ä–Ω—É–ª—Å—è!", show_alert=True)
        return

    # 2. –õ–æ–≥–∏–∫–∞ –Ω–∞–≥—Ä–∞–¥—ã (—Å—á–∏—Ç–∞–µ–º —Å—Ä–∞–∑—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∫–æ–Ω—Ü–µ)
    reward_mandarins = random.randint(15, 30)
    
    # –ë—É—Å—Ç—ã
    boosts = ["milk_x2", "tomato_x2", "water_free", "luck_max"]
    chosen_boost = random.choices(boosts, weights=[40, 30, 20, 10], k=1)[0]
    boost_names = {
        "milk_x2": "ü•õ –ú–æ–ª–æ—á–Ω—ã–π –ø–æ—Ç–æ–∫", "tomato_x2": "üçÖ –ì–∏–≥–∞-–¢–æ–º–∞—Ç",
        "water_free": "üåä –î–æ–∂–¥—å", "luck_max": "üçÄ –ö–ª–µ–≤–µ—Ä"
    }
    
    # –ó–∞–ø–∏—Å—å –≤ –ë–î
    end_time = now + BOOST_DURATION
    async with aiosqlite.connect(DB_NAME) as db:
        # –ù–∞—á–∏—Å–ª—è–µ–º –º–∞–Ω–¥–∞—Ä–∏–Ω—ã
        await db.execute('UPDATE users SET mandarins = mandarins + ? WHERE user_id = ?', (reward_mandarins, user_id))
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä—ã –∏–≤–µ–Ω—Ç–∞
        await db.execute(
            'UPDATE users SET last_scarecrow = ?, active_boost = ?, boost_end = ? WHERE user_id = ?', 
            (now, chosen_boost, end_time, user_id)
        )
        await db.commit()

    # --- –ó–ê–ü–£–°–ö –ê–ù–ò–ú–ê–¶–ò–ò ---
    
    # –ß—Ç–æ–±—ã –∞–Ω–∏–º–∞—Ü–∏—è –±—ã–ª–∞ –ø–ª–∞–≤–Ω–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º try-except –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç, –±–µ—Ä–µ–º —Å—Å—ã–ª–∫—É URL
    
    # –ö–ê–î–† 1: –ó–∞–º–∞—Ö
    try:
        media1 = InputMediaPhoto(media=FSInputFile(GRINCH_FRAMES[0]), caption="üóª <b>–ì—Ä–∏–Ω—á –Ω–∞–±–ª—é–¥–∞–µ—Ç..</b>", parse_mode="HTML")
    except:
        media1 = InputMediaPhoto(media=GRINCH_URLS[0], caption="üóª <b>–ì—Ä–∏–Ω—á –Ω–∞–±–ª—é–¥–∞–µ—Ç..</b>", parse_mode="HTML")
    
    await cb.message.edit_media(media=media1)
    await asyncio.sleep(1.0) # –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É
    
    # –ö–ê–î–† 2: –£–¥–∞—Ä
    try:
        media2 = InputMediaPhoto(media=FSInputFile(GRINCH_FRAMES[1]), caption="‚ùÑ <b>–ó–∞–º–∞—Ö... –õ–µ—Ç–∏—Ç!</b>", parse_mode="HTML")
    except:
        media2 = InputMediaPhoto(media=GRINCH_URLS[1], caption="‚ùÑ <b>–ó–∞–º–∞—Ö... –õ–µ—Ç–∏—Ç!</b>", parse_mode="HTML")
        
    await cb.message.edit_media(media=media2)
    await asyncio.sleep(1.0) # –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É

    # –ö–ê–î–† 3: –£–¥–∞—Ä
    try:
        media3 = InputMediaPhoto(media=FSInputFile(GRINCH_FRAMES[1]), caption="üí• <b>–ë–ê–ú! –ü—Ä—è–º–æ –≤ –ª–∏—Ü–æ!</b>", parse_mode="HTML")
    except:
        media3 = InputMediaPhoto(media=GRINCH_URLS[1], caption="üí• <b>–ë–ê–ú! –ü—Ä—è–º–æ –≤ –ª–∏—Ü–æ!</b>", parse_mode="HTML")
        
    await cb.message.edit_media(media=media3)
    await asyncio.sleep(1.0) # –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É

    # –ö–ê–î–† 3: –§–∏–Ω–∞–ª (–ü–æ–±–µ–≥ + –ù–∞–≥—Ä–∞–¥—ã)
    final_caption = (
        f"üë∫ <b>–ì—Ä–∏–Ω—á –ø–æ–≤–µ—Ä–∂–µ–Ω!</b>\n"
        f"–ó–ª–æ–¥–µ–π —É–±–µ–∂–∞–ª –≤ –≥–æ—Ä—ã, —Ä–æ–Ω—è—è –ø–æ–¥–∞—Ä–∫–∏.\n\n"
        f"üçä <b>–ù–∞–≥—Ä–∞–¥–∞:</b> +{reward_mandarins} –º–∞–Ω–¥–∞—Ä–∏–Ω–æ–≤\n"
        f"‚ö°Ô∏è <b>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –±—É—Å—Ç:</b> {boost_names[chosen_boost]} (30 –º–∏–Ω)"
    )
    
    try:
        media3 = InputMediaPhoto(media=FSInputFile(GRINCH_FRAMES[2]), caption=final_caption, parse_mode="HTML")
    except:
        media3 = InputMediaPhoto(media=GRINCH_URLS[2], caption=final_caption, parse_mode="HTML")

    await cb.message.edit_media(media=media3)
    await cb.answer()

@dp.message(F.text == "üéÖ –õ–∞–≤–∫–∞ –°–∞–Ω—Ç—ã")
async def santa_shop(message: types.Message):
    # –ü–æ–ª—É—á–∞–µ–º –º–∞–Ω–¥–∞—Ä–∏–Ω—ã (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –∫–æ–ª–æ–Ω–∫–∞ mandarins)
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT mandarins FROM users WHERE user_id = ?', (message.from_user.id,)) as c:
            mandarins = (await c.fetchone())[0]

    text = (
        f"üéÖ <b>–•–æ-—Ö–æ-—Ö–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>\n"
        f"–£ —Ç–µ–±—è –µ—Å—Ç—å: <b>{mandarins} üçä</b>\n\n"
        f"–ß—Ç–æ —Ö–æ—á–µ—à—å –∫—É–ø–∏—Ç—å?"
    )
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üéÅ –ë–æ–ª—å—à–æ–π –ü–æ–¥–∞—Ä–æ–∫ (50 üçä)", callback_data="buy_gift_box")],
        [InlineKeyboardButton(text="üß™ –Ø—â–∏–∫ –•–∏–º–∏–∏ (30 üçä)", callback_data="buy_fert_box")],
        [InlineKeyboardButton(text="üí∞ –û–±–º–µ–Ω—è—Ç—å –Ω–∞ –ø–æ–º–∏–¥–æ—Ä—ã (10 üçä = 500üçÖ)", callback_data="ex_mand_tom")]
    ])
    
    # –ö–∞—Ä—Ç–∏–Ω–∫–∞ –°–∞–Ω—Ç—ã (–Ω–∞–π–¥–∏ –≤ –∏–Ω–µ—Ç–µ santa.jpg)
    # await message.answer_photo(FSInputFile("santa.jpg"), caption=text, reply_markup=kb, parse_mode="HTML")
    await message.answer(text, reply_markup=kb, parse_mode="HTML")

# –•–µ–Ω–¥–ª–µ—Ä –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–∞—Ä–∫–∞
@dp.callback_query(F.data == "buy_gift_box")
async def buy_gift(cb: CallbackQuery):
    user_id = cb.from_user.id
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT mandarins, tomatoes, milk, fertilizer FROM users WHERE user_id = ?', (user_id,)) as c:
            u = await c.fetchone()
            
    if u[0] >= 50:
        # –°–ø–∏—Å—ã–≤–∞–µ–º
        await update_stat(user_id, "mandarins", u[0] - 50)
        
        # –†–∞–Ω–¥–æ–º–Ω—ã–π –ø—Ä–∏–∑
        prize_roll = random.random()
        if prize_roll < 0.5:
            prize = 5000
            await update_stat(user_id, "tomatoes", u[1] + prize)
            res = f"üçÖ {prize} –ø–æ–º–∏–¥–æ—Ä–æ–≤!"
        elif prize_roll < 0.8:
            prize = 3000
            await update_stat(user_id, "milk", u[2] + prize)
            res = f"ü•õ {prize} –ª. –º–æ–ª–æ–∫–∞!"
        else:
            prize = 10
            await update_stat(user_id, "fertilizer", u[3] + prize)
            res = f"üß™ {prize} —à—Ç. —Ö–∏–º–∏–∏!"
            
        await cb.message.edit_text(f"üéÅ <b>–¢—ã –æ—Ç–∫—Ä—ã–ª –ø–æ–¥–∞—Ä–æ–∫!</b>\n–í–Ω—É—Ç—Ä–∏: <b>{res}</b>", parse_mode="HTML")
    else:
        await cb.answer("‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–∞–Ω–¥–∞—Ä–∏–Ω–æ–≤!", show_alert=True)

# --- –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –ú–ï–ù–Æ ---

@dp.message(F.text == "üè∞ –ì–æ—Ä–æ–¥")
async def nav_town(message: types.Message):
    await message.answer("üèô –í—ã –ø—Ä–∏—à–ª–∏ –Ω–∞ –≥–æ—Ä–æ–¥—Å–∫—É—é –ø–ª–æ—â–∞–¥—å.", reply_markup=town_keyboard())

@dp.message(F.text == "üé¥ –ö–∞—Ä—Ç–æ—á–∫–∏")
async def show_cards(message: types.Message):
    user_id = message.from_user.id
    
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT card_id, count FROM user_cards WHERE user_id = ? AND count > 0', (user_id,)) as c:
            my_cards = await c.fetchall()

    if not my_cards:
        await message.answer("üéí –¢–≤–æ–π –∞–ª—å–±–æ–º —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –ø—É—Å—Ç.")
        return

    text = "üéí <b>–¢–í–û–Ø –ö–û–õ–õ–ï–ö–¶–ò–Ø:</b>\n\n"
    kb_builder = []
    
    for card_id, count in my_cards:
        if card_id not in CARDS: continue # –ó–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç
        
        card_data = CARDS[card_id]
        rarity = RARITY_INFO[card_data["rarity"]]
        
        text += f"{rarity['icon']} <b>{card_data['name']}</b> ‚Äî {count} —à—Ç.\n"
        
        # –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–∞—Ç—å [–ù–∞–∑–≤–∞–Ω–∏–µ]"
        kb_builder.append([InlineKeyboardButton(text=f"üí∞ –ü—Ä–æ–¥–∞—Ç—å: {card_data['name']}", callback_data=f"sell_init_{card_id}")])

    kb = InlineKeyboardMarkup(inline_keyboard=kb_builder)
    await message.answer(text, reply_markup=kb, parse_mode="HTML")

@dp.message(F.text == "üé° –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è")
async def nav_fun(message: types.Message):
    await message.answer("üé™ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞—Ä–∫ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–π!", reply_markup=fun_keyboard())

@dp.message(F.text == "üîô –ù–∞–∑–∞–¥")
async def nav_back(message: types.Message):
    await message.answer("üè° –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –Ω–∞ —Ñ–µ—Ä–º—É.", reply_markup=main_keyboard())

# --- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ (GUI) ---

# 1. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∫–∏
@dp.message(Command("admin"))
async def admin_panel_start(message: types.Message, state: FSMContext):
    if message.from_user.username.lower() not in ADMINS:
        return # –ò–≥–Ω–æ—Ä–∏–º –Ω–µ –∞–¥–º–∏–Ω–æ–≤

    await state.clear() # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ—à–ª—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    
    text = "üïµÔ∏è‚Äç‚ôÇÔ∏è <b>–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π:"
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí∞ –†–µ—Å—É—Ä—Å—ã (–í—ã–¥–∞—Ç—å/–ó–∞–±—Ä–∞—Ç—å)", callback_data="admin_cat_eco")],
        [InlineKeyboardButton(text="üë§ –ò–≥—Ä–æ–∫–∏ (–ë–∞–Ω/–ü—Ä–µ—Ñ–∏–∫—Å)", callback_data="admin_cat_users")],
        [InlineKeyboardButton(text="‚ùå –ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å", callback_data="admin_close")]
    ])
    
    await message.answer(text, reply_markup=kb, parse_mode="HTML")

# 2. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –≠–∫–æ–Ω–æ–º–∏–∫–∞
@dp.callback_query(F.data == "admin_cat_eco")
async def admin_eco_menu(cb: CallbackQuery):
    text = "üí∞ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≠–∫–æ–Ω–æ–º–∏–∫–æ–π</b>\n–ß—Ç–æ –º–µ–Ω—è–µ–º?"
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üçÖ –ü–æ–º–∏–¥–æ—Ä—ã", callback_data="adm_res_tomatoes"),
         InlineKeyboardButton(text="ü•õ –ú–æ–ª–æ–∫–æ", callback_data="adm_res_milk")],
        [InlineKeyboardButton(text="üçä –ú–∞–Ω–¥–∞—Ä–∏–Ω—ã", callback_data="adm_res_mandarins"),
         InlineKeyboardButton(text="üß™ –•–∏–º–∏—è", callback_data="adm_res_fertilizer")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_back_main")]
    ])
    await cb.message.edit_text(text, reply_markup=kb, parse_mode="HTML")

# 3. –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ò–≥—Ä–æ–∫–∏
@dp.callback_query(F.data == "admin_cat_users")
async def admin_users_menu(cb: CallbackQuery):
    text = "üë§ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–≥—Ä–æ–∫–∞–º–∏</b>\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:"
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üö´ –ë–ê–ù / –†–ê–ó–ë–ê–ù", callback_data="adm_act_ban")],
        [InlineKeyboardButton(text="üè∑ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ü–†–ï–§–ò–ö–°", callback_data="adm_act_prefix")],
        [InlineKeyboardButton(text="üî∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –°–¢–ê–¢–£–°", callback_data="adm_act_status")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="admin_back_main")]
    ])
    await cb.message.edit_text(text, reply_markup=kb, parse_mode="HTML")

# 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –∏ "–ó–∞–∫—Ä—ã—Ç—å"
@dp.callback_query(F.data == "admin_back_main")
async def admin_back(cb: CallbackQuery):
    await admin_panel_start(cb.message, None) # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –º–µ–Ω—é (–Ω—É–∂–µ–Ω –∫–æ—Å—Ç—ã–ª—å –¥–ª—è state, –Ω–æ —Ç—É—Ç –ø–æ—Ñ–∏–≥)
    await cb.answer()

@dp.callback_query(F.data == "admin_close")
async def admin_close(cb: CallbackQuery):
    await cb.message.delete()

# --- –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô (–®–ê–ì 1: –í—ã–±–æ—Ä —Ä–µ—Å—É—Ä—Å–∞/–¥–µ–π—Å—Ç–≤–∏—è) ---

# –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ —Ä–µ—Å—É—Ä—Å (–ü–æ–º–∏–¥–æ—Ä—ã/–ú–æ–ª–æ–∫–æ...)
@dp.callback_query(F.data.startswith("adm_res_"))
async def admin_select_resource(cb: CallbackQuery, state: FSMContext):
    resource = cb.data.split("_")[2] # tomatoes, milk...
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Å—É—Ä—Å, —Ç–µ–ø–µ—Ä—å —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –¢–ò–ü –æ–ø–µ—Ä–∞—Ü–∏–∏
    await state.update_data(target_resource=resource)
    
    text = f"‚öôÔ∏è –†–∞–±–æ—Ç–∞–µ–º —Å: <b>{resource.upper()}</b>\n–í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é:"
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ûï –í–´–î–ê–¢–¨ (Add)", callback_data="adm_op_add"),
         InlineKeyboardButton(text="‚ûñ –ó–ê–ë–†–ê–¢–¨ (Remove)", callback_data="adm_op_remove")],
        [InlineKeyboardButton(text="‚úèÔ∏è –£–°–¢–ê–ù–û–í–ò–¢–¨ (Set)", callback_data="adm_op_set")],
        [InlineKeyboardButton(text="üîô –û—Ç–º–µ–Ω–∞", callback_data="admin_cat_eco")]
    ])
    await cb.message.edit_text(text, reply_markup=kb, parse_mode="HTML")

# –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ —Å –∏–≥—Ä–æ–∫–æ–º (–ë–∞–Ω/–ü—Ä–µ—Ñ–∏–∫—Å...)
@dp.callback_query(F.data.startswith("adm_act_"))
async def admin_select_user_action(cb: CallbackQuery, state: FSMContext):
    action = cb.data.split("_")[2] # ban, prefix, status
    await state.update_data(target_action=action)
    
    # –°—Ä–∞–∑—É –ø—Ä–æ—Å–∏–º ID
    await cb.message.edit_text("‚úçÔ∏è <b>–í–≤–µ–¥–∏ ID –∏–≥—Ä–æ–∫–∞:</b>\n(–ú–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–≥—Ä–æ–∫–∞)", parse_mode="HTML")
    await state.set_state(AdminPanelStates.waiting_for_user_id)

# --- –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô (–®–ê–ì 2: –í—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤) ---
@dp.callback_query(F.data.startswith("adm_op_"))
async def admin_select_operation(cb: CallbackQuery, state: FSMContext):
    operation = cb.data.split("_")[2] # add, remove, set
    await state.update_data(target_operation=operation)
    
    await cb.message.edit_text("‚úçÔ∏è <b>–í–≤–µ–¥–∏ ID –∏–≥—Ä–æ–∫–∞:</b>", parse_mode="HTML")
    await state.set_state(AdminPanelStates.waiting_for_user_id)

# --- –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô (–®–ê–ì 3: –ü–æ–ª—É—á–µ–Ω–∏–µ ID) ---
@dp.message(StateFilter(AdminPanelStates.waiting_for_user_id))
async def admin_get_id(message: types.Message, state: FSMContext):
    try:
        user_id = int(message.text)
    except:
        await message.answer("‚ùå ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π —é–∑–µ—Ä
    user = await get_user(user_id)
    if not user:
        await message.answer("‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
        return

    await state.update_data(target_user_id=user_id)
    
    # –°–º–æ—Ç—Ä–∏–º, —á—Ç–æ –º—ã –¥–µ–ª–∞–ª–∏. –ï—Å–ª–∏ —ç—Ç–æ –ë–ê–ù - –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ (–∏–ª–∏ –Ω—É–∂–Ω–æ 1/0)
    data = await state.get_data()
    
    if "target_action" in data and data["target_action"] == "ban":
        # –ú–µ–Ω—é –±–∞–Ω–∞
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="üî® –ó–ê–ë–ê–ù–ò–¢–¨", callback_data="adm_ban_do_1"),
             InlineKeyboardButton(text="üòá –†–ê–ó–ë–ê–ù–ò–¢–¨", callback_data="adm_ban_do_0")]
        ])
        await message.answer(f"–ò–≥—Ä–æ–∫: {user[1]} (ID: {user_id})\n–ß—Ç–æ –¥–µ–ª–∞–µ–º?", reply_markup=kb)
        await state.clear() # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–µ–π—Ç, —Ç–∞–∫ –∫–∞–∫ –¥–∞–ª—å—à–µ –∫–Ω–æ–ø–∫–∏
        return

    # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–æ—Å–∏–º –ó–ù–ê–ß–ï–ù–ò–ï
    await message.answer("‚úçÔ∏è <b>–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>\n(–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Å—É—Ä—Å–æ–≤, —Ç–µ–∫—Å—Ç –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å)", parse_mode="HTML")
    await state.set_state(AdminPanelStates.waiting_for_value)

# --- –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô (–®–ê–ì 4: –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ë–ê–ù–ê) ---
@dp.callback_query(F.data.startswith("adm_ban_do_"))
async def admin_exec_ban(cb: CallbackQuery):
    val = int(cb.data.split("_")[3]) # 1 –∏–ª–∏ 0
    # –ù–∞–º –Ω—É–∂–µ–Ω ID –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –Ω–æ –º—ã —Å–±—Ä–æ—Å–∏–ª–∏ —Å—Ç–µ–π—Ç. 
    # –≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –£–ø—Ä–æ—Å—Ç–∏–º: –ø–µ—Ä–µ–Ω–µ—Å–µ–º ID –≤ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏–º –∑–∞–Ω–æ–≤–æ.
    # –õ–£–ß–®–ï–ï –†–ï–®–ï–ù–ò–ï: –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –±–∞–Ω–∞, –ø–µ—Ä–µ–¥–∞—Ç—å ID –≤ callback_data, –Ω–æ –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º.
    # –î–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º –ø—Ä–æ—â–µ: –ë–∞–Ω —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /ban ID –≤ –∫–æ–Ω—Å–æ–ª–∏, –∞ —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ –≤ value –Ω–∞–ø–∏—à–µ–º 1 –∏–ª–∏ 0.
    # –ù–æ —Ä–∞–∑ –º—ã —É–∂–µ —Ç—É—Ç: –≤–µ—Ä–Ω–µ–º—Å—è –≤ —Å—Ç–µ–π—Ç value.
    await cb.answer("–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –≤–≤–æ–¥ 1 (–±–∞–Ω) –∏–ª–∏ 0 (—Ä–∞–∑–±–∞–Ω) –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ.")

# --- –õ–û–ì–ò–ö–ê –î–ï–ô–°–¢–í–ò–ô (–®–ê–ì 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –ó–ù–ê–ß–ï–ù–ò–Ø –∏ –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ) ---
@dp.message(StateFilter(AdminPanelStates.waiting_for_value))
async def admin_exec_final(message: types.Message, state: FSMContext):
    value_raw = message.text
    data = await state.get_data()
    
    target_id = data['target_user_id']
    
    async with aiosqlite.connect(DB_NAME) as db:
        
        # === –í–ï–¢–ö–ê: –†–ï–°–£–†–°–´ ===
        if "target_resource" in data:
            res = data["target_resource"] # tomatoes, milk...
            op = data["target_operation"] # add, remove, set
            
            try:
                amount = int(value_raw)
            except:
                await message.answer("‚ùå –î–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –ß–ò–°–õ–û.")
                return

            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ
            async with db.execute(f'SELECT {res} FROM users WHERE user_id = ?', (target_id,)) as c:
                current = (await c.fetchone())[0]

            new_val = current
            if op == "add": new_val += amount
            elif op == "remove": new_val -= amount
            elif op == "set": new_val = amount
            
            # –ó–∞—â–∏—Ç–∞ –æ—Ç –º–∏–Ω—É—Å–∞
            if new_val < 0: new_val = 0
            
            await db.execute(f'UPDATE users SET {res} = ? WHERE user_id = ?', (new_val, target_id))
            await db.commit()
            
            await message.answer(f"‚úÖ –£—Å–ø–µ—à–Ω–æ! {res.upper()} –∏–≥—Ä–æ–∫–∞ {target_id} –∏–∑–º–µ–Ω–µ–Ω—ã.\n–ë—ã–ª–æ: {current} -> –°—Ç–∞–ª–æ: {new_val}")

        # === –í–ï–¢–ö–ê: –ò–ì–†–û–ö–ò (–ü—Ä–µ—Ñ–∏–∫—Å, –°—Ç–∞—Ç—É—Å, –ë–∞–Ω) ===
        elif "target_action" in data:
            act = data["target_action"]
            
            if act == "prefix":
                # –ï—Å–ª–∏ –≤–≤–µ–ª–∏ "-", —É–¥–∞–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
                val = None if value_raw == "-" else value_raw
                await db.execute('UPDATE users SET prefix = ? WHERE user_id = ?', (val, target_id))
                await message.answer(f"‚úÖ –ü—Ä–µ—Ñ–∏–∫—Å –∏–≥—Ä–æ–∫–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {val}")
                
            elif act == "status":
                await db.execute('UPDATE users SET custom_status = ? WHERE user_id = ?', (value_raw, target_id))
                await message.answer(f"‚úÖ –°—Ç–∞—Ç—É—Å –∏–≥—Ä–æ–∫–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {value_raw}")
            
            elif act == "ban":
                try:
                    is_ban = int(value_raw) # –û–∂–∏–¥–∞–µ–º 1 –∏–ª–∏ 0
                    await db.execute('UPDATE users SET is_banned = ? WHERE user_id = ?', (is_ban, target_id))
                    status = "–ó–ê–ë–ê–ù–ï–ù üö´" if is_ban else "–†–ê–ó–ë–ê–ù–ï–ù üòá"
                    await message.answer(f"‚úÖ –ò–≥—Ä–æ–∫ {status}")
                except:
                    await message.answer("‚ùå –î–ª—è –±–∞–Ω–∞ –≤–≤–µ–¥–∏ 1, –¥–ª—è —Ä–∞–∑–±–∞–Ω–∞ 0.")

        await db.commit()
    
    await state.clear()

# --- –ê–î–ú–ò–ù-–ö–û–ù–°–û–õ–¨ ---
async def admin_console_loop(bot: Bot):
    print(f"{Fore.YELLOW}üñ• SUPER-CONSOLE v2.0 –∑–∞–ø—É—â–µ–Ω–∞!{Style.RESET_ALL}")
    print("–ö–æ–º–∞–Ω–¥—ã: list, search, delete, setadmin, stats, give, bc, info")
    
    while True:
        try:
            command_raw = await aioconsole.ainput(f"{Fore.BLUE}admin@{bot.token.split(':')[0]}~# {Style.RESET_ALL}")
            parts = command_raw.split()
            if not parts: continue
            cmd = parts[0].lower()

            # === LIST: –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ ===
            if cmd == "list":
                async with aiosqlite.connect(DB_NAME) as db:
                    # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                    async with db.execute('SELECT user_id, username, tomatoes FROM users ORDER BY user_id DESC LIMIT 50') as c:
                        users = await c.fetchall()
                
                print(f"{Fore.CYAN}--- –°–ü–ò–°–û–ö –ò–ì–†–û–ö–û–í (–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50) ---{Style.RESET_ALL}")
                print(f"{'ID':<12} | {'Username':<20} | {'–ë–∞–ª–∞–Ω—Å':<10}")
                print("-" * 50)
                for u in users:
                    name = u[1] if u[1] else "NoName"
                    print(f"{u[0]:<12} | {name:<20} | {u[2]:<10}")
                print("-" * 50)

            # === SET: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤ ===
            elif cmd == "set":
                # –§–æ—Ä–º–∞—Ç: set <username> <field> <value>
                if len(parts) < 4:
                    print(f"{Fore.YELLOW}üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: set <username> <–ø–∞—Ä–∞–º–µ—Ç—Ä> <–∑–Ω–∞—á–µ–Ω–∏–µ>{Style.RESET_ALL}")
                    print(f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: milk, tomatoes, fertilizer, mandarins, click_level, tomato_level, luck_level, is_banned, reg_date")
                    continue
                
                target_name = parts[1]
                field = parts[2].lower()
                value_raw = parts[3]

                # –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π (—á—Ç–æ–±—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–µ —Å–ª–æ–º–∞—Ç—å ID –∏–ª–∏ —á—Ç–æ-—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–æ–µ)
                allowed_fields = [
                    "milk", "tomatoes", "fertilizer", "mandarins", 
                    "click_level", "tomato_level", "luck_level", "safety_level", 
                    "eco_level", "casino_level", "gmo_level", 
                    "sosi_count", "is_banned", "reg_date", "is_admin", "prefix", "custom_status"
                ]

                if field not in allowed_fields:
                    print(f"{Fore.RED}‚ùå –û—à–∏–±–∫–∞: –ü–∞—Ä–∞–º–µ—Ç—Ä '{field}' –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.{Style.RESET_ALL}")
                    print(f"–†–∞–∑—Ä–µ—à–µ–Ω–æ: {', '.join(allowed_fields)}")
                    continue

                async with aiosqlite.connect(DB_NAME) as db:
                    # 1. –ò—â–µ–º –∏–≥—Ä–æ–∫–∞ –ø–æ –Ω–∏–∫—É
                    async with db.execute('SELECT user_id, username FROM users WHERE username = ?', (target_name,)) as c:
                        user = await c.fetchone()
                    
                    if not user:
                        print(f"{Fore.RED}‚ùå –ò–≥—Ä–æ–∫ '{target_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω.{Style.RESET_ALL}")
                        continue
                    
                    target_id = user[0]

                    # 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                    # –ï—Å–ª–∏ –º–µ–Ω—è–µ–º reg_date (–≤—Ä–µ–º—è –≤ –∏–≥—Ä–µ), –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–ª-–≤–æ —á–∞—Å–æ–≤, –∏ –º—ã –æ—Ç–Ω–∏–º–µ–º –∏—Ö –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                    if field == "reg_date":
                        try:
                            # –ï—Å–ª–∏ –≤–≤–µ–ª–∏ "0", —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ "—Å–µ–π—á–∞—Å"
                            if value_raw == "0":
                                final_value = time.time()
                                print(f"üïí –í—Ä–µ–º—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–±—Ä–æ—à–µ–Ω–æ –Ω–∞ –°–ï–ô–ß–ê–°.")
                            else:
                                # –ï—Å–ª–∏ –≤–≤–µ–ª–∏ —á–∞—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100), –¥–µ–ª–∞–µ–º –≤–∏–¥, —á—Ç–æ —Ä–µ–≥–∞ –±—ã–ª–∞ 100 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
                                hours = float(value_raw)
                                final_value = time.time() - (hours * 3600)
                                print(f"üïí –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞–∂: {hours} —á–∞—Å–æ–≤.")
                        except:
                            print("‚ùå –î–ª—è –≤—Ä–µ–º–µ–Ω–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ (—á–∏—Å–ª–æ).")
                            continue
                    
                    # –ï—Å–ª–∏ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (–ø—Ä–µ—Ñ–∏–∫—Å, —Å—Ç–∞—Ç—É—Å)
                    elif field in ["prefix", "custom_status"]:
                        # –ï—Å–ª–∏ –≤ –∑–Ω–∞—á–µ–Ω–∏–∏ –ø—Ä–æ–±–µ–ª—ã, –Ω—É–∂–Ω–æ —Å–∫–ª–µ–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ parts[3:]
                        final_value = " ".join(parts[3:])
                        if final_value == "-": final_value = None # –£–¥–∞–ª–µ–Ω–∏–µ
                    
                    # –î–ª—è –≤—Å–µ—Ö —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
                    else:
                        try:
                            final_value = int(value_raw)
                        except ValueError:
                            print(f"{Fore.RED}‚ùå –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è '{field}' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º!{Style.RESET_ALL}")
                            continue

                    # 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    try:
                        await db.execute(f'UPDATE users SET {field} = ? WHERE user_id = ?', (final_value, target_id))
                        await db.commit()
                        print(f"{Fore.GREEN}‚úÖ –£—Å–ø–µ—à–Ω–æ! –ò–≥—Ä–æ–∫: {target_name} | {field} -> {final_value}{Style.RESET_ALL}")
                        
                        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏—é, –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)
                        try:
                            msg = f"‚úèÔ∏è <b>–ê–¥–º–∏–Ω –∏–∑–º–µ–Ω–∏–ª –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:</b>\n{field} = {final_value}"
                            if field == "is_banned" and final_value == 1: msg = "üö´ <b>–í–´ –ó–ê–ë–ê–ù–ï–ù–´ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–û–ú!</b>"
                            if field == "is_banned" and final_value == 0: msg = "üòá <b>–í–ê–° –†–ê–ó–ë–ê–ù–ò–õ–ò!</b>"
                            await bot.send_message(target_id, msg, parse_mode="HTML")
                        except: pass
                        
                    except Exception as e:
                        print(f"{Fore.RED}üí• –û—à–∏–±–∫–∞ –ë–î: {e}{Style.RESET_ALL}")

            # === SEARCH: –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞ ===
            elif cmd == "search":
                if len(parts) < 2:
                    print("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: search <—á–∞—Å—Ç—å_–Ω–∏–∫–∞>")
                    continue
                
                query = parts[1]
                async with aiosqlite.connect(DB_NAME) as db:
                    async with db.execute('SELECT * FROM users WHERE username LIKE ?', (f'%{query}%',)) as c:
                        rows = await c.fetchall()
                
                if not rows:
                    print("‚ùå –ò–≥—Ä–æ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
                else:
                    for u in rows:
                        # u[0]=id, u[1]=name, u[2]=milk, u[3]=tom, ... u[14]=is_admin (–µ—Å–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É)
                        print(f"\nüîé {Fore.GREEN}–ù–ê–ô–î–ï–ù –ò–ì–†–û–ö:{Style.RESET_ALL}")
                        print(f"üÜî ID: {u[0]}")
                        print(f"üë§ Nick: {u[1]}")
                        print(f"üçÖ –ü–æ–º–∏–¥–æ—Ä—ã: {format_num(u[3])}")
                        print(f"ü•õ –ú–æ–ª–æ–∫–æ: {format_num(u[2])}")
                        print(f"üìÖ –†–µ–≥: {time.ctime(u[16] if len(u) > 16 else 0)}") # –ò–Ω–¥–µ–∫—Å –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è
                        print(f"üëÆ –ê–¥–º–∏–Ω: {'–î–ê' if u[-2] == 1 else '–ù–ï–¢'}") # is_admin –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–∏–π

            # === DELETE: –£–¥–∞–ª–µ–Ω–∏–µ (—Å –∑–∞—â–∏—Ç–æ–π) ===
            elif cmd == "delete":
                if len(parts) < 2:
                    print("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: delete <username>")
                    continue
                
                target_name = parts[1]
                async with aiosqlite.connect(DB_NAME) as db:
                    # –ò—â–µ–º ID
                    async with db.execute('SELECT user_id, username, tomatoes FROM users WHERE username = ?', (target_name,)) as c:
                        target = await c.fetchone()
                    
                    if not target:
                        print("‚ùå –ò–≥—Ä–æ–∫ —Å —Ç–∞–∫–∏–º —é–∑–µ—Ä–Ω–µ–π–º–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–≤–æ–¥–∏—Ç–µ —Ç–æ—á–Ω—ã–π username –±–µ–∑ @).")
                        continue
                    
                    t_id, t_name, t_balance = target
                    
                    # –≠–¢–ê–ü 1: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    print(f"{Fore.RED}‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞:{Style.RESET_ALL}")
                    print(f"ID: {t_id} | Name: {t_name} | Bal: {t_balance}")
                    print("–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û. –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –∫–∞—Ä—Ç—ã –±—É–¥—É—Ç —Å—Ç–µ—Ä—Ç—ã.")
                    
                    confirm1 = await aioconsole.ainput(f"–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ {Fore.RED}DELETE{Style.RESET_ALL}: ")
                    
                    if confirm1 != "DELETE":
                        print("üö´ –û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è.")
                        continue
                        
                    # –≠–¢–ê–ü 2: –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                    confirm2 = await aioconsole.ainput(f"–í–≤–µ–¥–∏—Ç–µ {Fore.RED}CONFIRM{Style.RESET_ALL} –¥–ª—è –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è: ")
                    
                    if confirm2 == "CONFIRM":
                        await db.execute('DELETE FROM users WHERE user_id = ?', (t_id,))
                        await db.execute('DELETE FROM user_cards WHERE user_id = ?', (t_id,))
                        await db.execute('DELETE FROM market WHERE seller_id = ?', (t_id,))
                        await db.commit()
                        print(f"{Fore.GREEN}‚úÖ –ê–∫–∫–∞—É–Ω—Ç {t_name} —É—Å–ø–µ—à–Ω–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω.{Style.RESET_ALL}")
                    else:
                        print("üö´ –û—Ç–º–µ–Ω–∞.")

            # === SETADMIN: –í—ã–¥–∞—Ç—å –∞–¥–º–∏–Ω–∫—É ===
            elif cmd == "setadmin":
                if len(parts) < 3:
                    print("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: setadmin <username> <1 –∏–ª–∏ 0>")
                    continue
                
                target_name = parts[1]
                try:
                    val = int(parts[2]) # 1 –∏–ª–∏ 0
                except:
                    print("‚ùå –ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1 (–¥–∞—Ç—å) –∏–ª–∏ 0 (—Å–Ω—è—Ç—å).")
                    continue

                async with aiosqlite.connect(DB_NAME) as db:
                    # –ò—â–µ–º –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É
                    async with db.execute('SELECT user_id FROM users WHERE username = ?', (target_name,)) as c:
                        res = await c.fetchone()
                    
                    if not res:
                        print("‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                        continue
                    
                    uid = res[0]
                    await db.execute('UPDATE users SET is_admin = ? WHERE user_id = ?', (val, uid))
                    await db.commit()
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –ø–∞–º—è—Ç–∏
                if val == 1:
                    if target_name.lower() not in ADMINS: ADMINS.append(target_name.lower())
                    print(f"{Fore.GREEN}‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_name} —Ç–µ–ø–µ—Ä—å –ê–î–ú–ò–ù!{Style.RESET_ALL}")
                    try: await bot.send_message(uid, "üòé <b>–í–∞–º –≤—ã–¥–∞–Ω—ã –ø—Ä–∞–≤–∞ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!</b>")
                    except: pass
                else:
                    if target_name.lower() in ADMINS: ADMINS.remove(target_name.lower())
                    print(f"{Fore.YELLOW}üî∏ –° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_name} —Å–Ω—è—Ç—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞.{Style.RESET_ALL}")

            # === STATS: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞ ===
            elif cmd == "stats":
                async with aiosqlite.connect(DB_NAME) as db:
                    # –û–±—â–µ–µ –∫–æ–ª-–≤–æ
                    async with db.execute('SELECT COUNT(*) FROM users') as c:
                        total_users = (await c.fetchone())[0]
                    # –û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞
                    async with db.execute('SELECT SUM(tomatoes), SUM(milk) FROM users') as c:
                        row = await c.fetchone()
                        total_tom = row[0] if row[0] else 0
                        total_milk = row[1] if row[1] else 0
                    
                    # –¢—Ä–∞—Ñ–∏–∫ (–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞ 24 —á–∞—Å–∞)
                    day_ago = time.time() - 86400
                    async with db.execute('SELECT COUNT(*) FROM users WHERE last_active > ?', (day_ago,)) as c:
                        active_24h = (await c.fetchone())[0]
                    
                    # –ù–æ–≤—ã–µ –∑–∞ 24 —á–∞—Å–∞
                    async with db.execute('SELECT COUNT(*) FROM users WHERE reg_date > ?', (day_ago,)) as c:
                        new_24h = (await c.fetchone())[0]

                print(f"\nüìä {Fore.MAGENTA}–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–ï–ö–¢–ê:{Style.RESET_ALL}")
                print(f"üë• –í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: {Fore.CYAN}{total_users}{Style.RESET_ALL}")
                print(f"üî• –ê–∫—Ç–∏–≤ (24—á): {Fore.GREEN}{active_24h}{Style.RESET_ALL} (–ù–æ–≤—ã—Ö: {new_24h})")
                print(f"üí∞ –≠–∫–æ–Ω–æ–º–∏–∫–∞:")
                print(f"   üçÖ –í—Å–µ–≥–æ –ø–æ–º–∏–¥–æ—Ä–æ–≤: {format_num(total_tom)}")
                print(f"   ü•õ –í—Å–µ–≥–æ –º–æ–ª–æ–∫–∞: {format_num(total_milk)}")
                avg = int(total_tom / total_users) if total_users > 0 else 0
                print(f"   üìà –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å: {format_num(avg)} üçÖ")

            # === –°—Ç–∞—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) ===
            elif cmd == "give":
                # ... (–≤–∞—à —Å—Ç–∞—Ä—ã–π –∫–æ–¥ give)
                try:
                    target_id = int(parts[1])
                    amount = int(parts[2])
                    await update_stat(target_id, "tomatoes", (await get_user(target_id))[3] + amount)
                    print(f"‚úÖ –í—ã–¥–∞–Ω–æ {amount} üçÖ ID: {target_id}")
                except: print("–û—à–∏–±–∫–∞ give")

            elif cmd == "bc": # Broadcast
                text = " ".join(parts[1:])
                print("üöÄ –†–∞—Å—Å—ã–ª–∫–∞...")
                async with aiosqlite.connect(DB_NAME) as db:
                    async with db.execute('SELECT user_id FROM users') as c:
                        users = await c.fetchall()
                count = 0
                for r in users:
                    try:
                        await bot.send_message(r[0], f"üîî {text}", parse_mode="HTML")
                        count += 1
                        await asyncio.sleep(0.05)
                    except: pass
                print(f"‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {count}")

            else:
                print("‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –î–æ—Å—Ç—É–ø–Ω—ã: list, search, delete, setadmin, stats, give, bc")

        except Exception as e:
            print(f"{Fore.RED}üí• –û—à–∏–±–∫–∞ –∫–æ–Ω—Å–æ–ª–∏: {e}{Style.RESET_ALL}")

# --- –ó–ê–ü–£–°–ö ---
async def main():
    await init_db() # –¢—É—Ç –ø—Ä–æ–π–¥—É—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
    
    # --- –ó–ê–ì–†–£–ó–ö–ê –ê–î–ú–ò–ù–û–í –ò–ó –ë–î ---
    async with aiosqlite.connect(DB_NAME) as db:
        async with db.execute('SELECT username FROM users WHERE is_admin = 1') as c:
            db_admins = await c.fetchall()
            for row in db_admins:
                if row[0] and row[0].lower() not in ADMINS:
                    ADMINS.append(row[0].lower())
    print(f"üëÆ‚Äç‚ôÇÔ∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞–¥–º–∏–Ω–æ–≤: {len(ADMINS)}")
    # ------------------------------

    await bot.delete_webhook(drop_pending_updates=True)
    await set_menu(bot)
    # –û—Ç–∫–ª—é—á–∞–µ–º –ª–∏—à–Ω–∏–π –º—É—Å–æ—Ä –≤ –ª–æ–≥–∞—Ö, —á—Ç–æ–±—ã –∫–æ–Ω—Å–æ–ª—å –±—ã–ª–∞ —á–∏—Å—Ç–æ–π
    logging.basicConfig(level=logging.ERROR)
    
    print(f"{Fore.GREEN}‚úÖ –ë–æ—Ç üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–µ–µ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –û–ø–µ—Ä–∞—Ü–∏—è –û–ª–∏–≤—å–µ –∑–∞–ø—É—â–µ–Ω!{Style.RESET_ALL}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –∏ –∫–æ–Ω—Å–æ–ª—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    await asyncio.gather(
        dp.start_polling(bot),
        admin_console_loop(bot)
    )

if __name__ == "__main__":
    asyncio.run(main())